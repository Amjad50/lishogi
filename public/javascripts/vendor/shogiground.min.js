var Shogiground=function(){"use strict";const e=["sente","gote"],o=["a","b","c","d","e","f","g","h","i"],t=["1","2","3","4","5","6","7","8","9"],n=["9","8","7","6","5","4","3","2","1"],r=Array.prototype.concat(...o.map((e=>t.map((o=>e+o))))),s=e=>r[9*(8-e[0])+(8-e[1])],i=e=>Number.isInteger(e[0])?[e.charCodeAt(0)-49,e.charCodeAt(1)-97]:[8-(e.charCodeAt(0)-97),8-(e.charCodeAt(1)-49)];const c=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const o=performance.now()-e;return e=void 0,o}}},a=e=>"sente"===e?"gote":"sente",l=(e,o)=>{const t=e[0]-o[0],n=e[1]-o[1];return t*t+n*n},d=(e,o)=>e.role===o.role&&e.color===o.color,u=(e,o,t,n,r)=>[(t?o.files-1-e[0]:e[0])*n,(t?e[1]:o.ranks-1-e[1])*r],p=(e,o)=>{const t=o.width/e.files,n=o.height/e.ranks;return(o,r)=>u(o,e,r,t,n)},f=(e,o,t=!0)=>{e.style.transform=`translate(${o[0]}px,${o[1]}px) ${t?"scale(0.5)":""}`},g=(e,o,t=!0)=>{const n=t?1:2;e.style.transform=`translate(${n*o[0]}%,${n*o[1]}%) ${t?"scale(0.5)":""}`},h=(e,o)=>{e.style.visibility=o?"visible":"hidden"},m=e=>e.clientX||0===e.clientX?[e.clientX,e.clientY]:e.touches&&e.targetTouches[0]?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0,v=e=>2===e.buttons||2===e.button,b=(e,o)=>{const t=document.createElement(e);return o&&(t.className=o),t},w=["pawn","lance","knight","silver","gold","bishop","rook"],k=["pawn","silver","gold","bishop","rook"];function y(e,o){return Math.abs(e-o)}const C=(e,o,t,n)=>y(e,t)===y(o,n),M=(e,o,t,n)=>e===t||o===n,S=(e,o,t,n)=>y(e,t)<2&&y(o,n)<2;const P=(e,o,t,n)=>S(e,o,t,n)||C(e,o,t,n),D=(e,o,t,n)=>S(e,o,t,n)||M(e,o,t,n),A=r.map(i);function L(e,o){const t=e.get(o);if(!t)return[];const n=i(o),r=t.role,c="pawn"===r?(a=t.color,(e,o,t,n)=>"sente"===a?e===t&&o-1===n:e===t&&o+1===n):"knight"===r?function(e){return(o,t,n,r)=>1===y(o,n)&&2===y(t,r)&&("sente"===e?r<t:r>t)}(t.color):"bishop"===r?C:"rook"===r?M:"king"===r?S:"silver"===r?function(e){return(o,t,n,r)=>y(o,n)<2&&y(t,r)<2&&t!=r&&("sente"===e?o!=n||r<t:o!=n||r>t)}(t.color):"lance"===r?function(e){return(o,t,n,r)=>"sente"===e?o==n&&r<t:o==n&&t<r}(t.color):"horse"===r?P:"dragon"===r?D:function(e){return(o,t,n,r)=>y(o,n)<2&&y(t,r)<2&&("sente"===e?r<=t||o==n:r>=t||o==n)}(t.color);var a;return A.filter((e=>(n[0]!==e[0]||n[1]!==e[1])&&c(n[0],n[1],e[0],e[1]))).map(s)}function K(e,...o){e&&setTimeout((()=>e(...o)),1)}function N(e){e.premovable.current&&(e.premovable.current=void 0,K(e.premovable.events.unset))}function x(e){const o=e.predroppable;o.current&&(o.current=void 0,K(o.events.unset))}function O(e,o,t){const n=e.pieces.get(o),r=e.pieces.get(t);if(o===t||!n)return!1;const s=r&&r.color!==n.color?r:void 0;return t===e.selected&&T(e),K(e.events.move,o,t,s),e.pieces.set(t,n),e.pieces.delete(o),e.lastMove=[o,t],e.check=void 0,K(e.events.change),s||!0}function $(e,o,t,n){if(e.pieces.has(t)){if(!n)return!1;e.pieces.delete(t)}return K(e.events.dropNewPiece,o,t),e.pieces.set(t,o),e.lastMove=[t],e.check=void 0,K(e.events.change),e.movable.dests=void 0,e.dropmode.dropDests=void 0,e.turnColor=a(e.turnColor),!0}function E(e,o,t){const n=O(e,o,t);return n&&(e.movable.dests=void 0,e.dropmode.dropDests=void 0,e.turnColor=a(e.turnColor),e.animation.current=void 0),n}function W(e,o,t){if(j(e,o,t)){const n=E(e,o,t);if(n){const r=e.hold.stop();T(e);const s={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return!0!==n&&(s.captured=n),K(e.movable.events.after,o,t,s),!0}}else if(function(e,o,t){return o!==t&&H(e,o)&&L(e.pieces,o).includes(t)}(e,o,t))return function(e,o,t,n){x(e),e.premovable.current=[o,t],K(e.premovable.events.set,o,t,n)}(e,o,t,{ctrlKey:e.stats.ctrlKey}),T(e),!0;return T(e),!1}function q(e,o,t,n){const r=e.pieces.get(o);r&&(function(e,o,t){const n=e.pieces.get(o);return!(!n||o!==t&&e.pieces.has(t)||"both"!==e.movable.color&&(e.movable.color!==n.color||e.turnColor!==n.color))}(e,o,t)||n)?(e.pieces.delete(o),$(e,r,t,n),K(e.movable.events.afterNewPiece,r.role,t,{predrop:!1})):r&&function(e,o,t){const n=e.pieces.get(o),r=e.pieces.get(t);return!!n&&(!r||r.color!==e.movable.color)&&e.predroppable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}(e,o,t)?function(e,o,t){N(e),e.predroppable.current={role:o,key:t},K(e.predroppable.events.set,o,t)}(e,r.role,t):(N(e),x(e)),e.pieces.delete(o),T(e)}function F(e,o,t){if(K(e.events.select,o),e.selected){if(e.selected===o&&!e.draggable.enabled)return T(e),void e.hold.cancel();if((e.selectable.enabled||t)&&e.selected!==o&&W(e,e.selected,o))return void(e.stats.dragged=!1)}(B(e,o)||H(e,o))&&(z(e,o),e.hold.start())}function z(e,o){e.selected=o,H(e,o)?e.premovable.dests=L(e.pieces,o):(e.premovable.dests=void 0,e.predroppable.dropDests=void 0)}function T(e){e.selected=void 0,e.premovable.dests=void 0,e.predroppable.dropDests=void 0,e.hold.cancel()}function B(e,o){const t=e.pieces.get(o);return!!t&&("both"===e.movable.color||e.movable.color===t.color&&e.turnColor===t.color)}function j(e,o,t){var n,r;return o!==t&&B(e,o)&&(e.movable.free||!!(null===(r=null===(n=e.movable.dests)||void 0===n?void 0:n.get(o))||void 0===r?void 0:r.includes(t)))}function H(e,o){const t=e.pieces.get(o);return!!t&&e.premovable.enabled&&e.movable.color===t.color&&e.turnColor!==t.color}function G(e){const o=e.premovable.current;if(!o)return!1;const t=o[0],n=o[1];let r=!1;if(j(e,t,n)){const o=E(e,t,n);if(o){const s={premove:!0};!0!==o&&(s.captured=o),K(e.movable.events.after,t,n,s),r=!0}}return N(e),r}function R(e){N(e),x(e),T(e)}function X(e){e.movable.color=e.movable.dests=e.dropmode.dropDests=e.animation.current=void 0,R(e)}function I(e,o,t,n){let r=Math.floor(t.files*(e[0]-n.left)/n.width);o&&(r=t.files-1-r);let i=t.ranks-1-Math.floor(t.ranks*(e[1]-n.top)/n.height);return o&&(i=t.ranks-1-i),r>=0&&r<t.files&&i>=0&&i<t.ranks?s([r,i]):void 0}function Y(e){return"sente"===e.orientation}const U="lnsgkgsnl/1r5b1/ppppppppp/9/9/9/PPPPPPPPP/1B5R1/LNSGKGSNL",J={p:"pawn",l:"lance",n:"knight",s:"silver",g:"gold",b:"bishop",r:"rook",k:"king","+p":"tokin",t:"tokin","+l":"promotedlance",u:"promotedlance","+n":"promotedknight",m:"promotedknight","+s":"promotedsilver",a:"promotedsilver","+b":"horse",h:"horse","+r":"dragon",d:"dragon"},Q={pawn:"p",lance:"l",knight:"n",silver:"s",gold:"g",bishop:"b",rook:"r",king:"k",tokin:"+p",promotedlance:"+l",promotedknight:"+n",promotedsilver:"+s",horse:"+b",dragon:"+r"};function V(e,o){"start"===e&&(e=U);const t=new Map;let n=o.files-1,r=0;for(let i=0;i<e.length;i++)switch(e[i]){case" ":case"_":return t;case"/":if(++r,r>o.ranks-1)return t;n=o.files-1;break;default:const c=e[i].charCodeAt(0);if(c<58&&43!=c)n-=c-48;else{const o="+"===e[i]&&e.length>i+1?"+"+e[++i].toLowerCase():e[i].toLowerCase(),c=e[i]===o||"+"+e[i]===o?"gote":"sente";n>=0&&t.set(s([n,r]),{role:J[o],color:c}),--n}}return t}const Z={p:"pawn",l:"lance",n:"knight",s:"silver",g:"gold",b:"bishop",r:"rook"};function _(e,o,t){const n="sente"===e.orientation!=("sente"==t)?"top":"bottom",r=b("div","pocket pocket-"+n);o.appendChild(r);const s=5===e.dimensions.ranks?k:w;for(const e of s){const o=b("div","pocket-c1");r.appendChild(o);const n=b("div","pocket-c2");o.appendChild(n);const s=b("piece",e+" "+t);s.setAttribute("data-role",e),s.setAttribute("data-color",t),s.setAttribute("data-nb","0"),n.appendChild(s)}return r}function ee(e,o){var t,n;(null===(t=o.movable)||void 0===t?void 0:t.dests)&&(e.movable.dests=void 0),(null===(n=o.dropmode)||void 0===n?void 0:n.dropDests)&&(e.dropmode.dropDests=void 0),oe(e,o),o.fen&&(e.dimensions=o.dimensions||function(e){const o=e.split("/").length;return{files:o,ranks:o}}(o.fen),e.pieces=V(o.fen,e.dimensions),e.drawable.shapes=[]),o.hasPockets&&(e.pockets=function(e){const o=[{pawn:0,lance:0,knight:0,silver:0,gold:0,bishop:0,rook:0},{pawn:0,lance:0,knight:0,silver:0,gold:0,bishop:0,rook:0}];if(!e)return o;try{let t=JSON.parse(e);for(const e of[0,1])for(const n of w)o[e][n]=t[e][n]||0}catch(t){let n=0;for(const t of e){const e=Z[t.toLowerCase()];e?(o[t.toLowerCase()===t?1:0][e]+=n||1,n=0):n=10*n+Number(t)}}return o}(o.pockets)),"check"in o&&function(e,o){if(e.check=void 0,!0===o&&(o=e.turnColor),o)for(const[t,n]of e.pieces)"king"===n.role&&n.color===o&&(e.check=t)}(e,o.check||!1),"lastMove"in o&&!o.lastMove?e.lastMove=void 0:o.lastMove&&(e.lastMove=o.lastMove),e.selected&&z(e,e.selected),(!e.animation.duration||e.animation.duration<100)&&(e.animation.enabled=!1)}function oe(e,o){for(const t in o)te(e[t])&&te(o[t])?oe(e[t],o[t]):e[t]=o[t]}function te(e){return"object"==typeof e}function ne(e,o){return o.animation.enabled?function(e,o){const t=new Map(o.pieces),n=e(o),s=function(e,o){const t=new Map,n=[],s=new Map,i=[],c=[],a=new Map;let l,u,p;for(const[o,t]of e)a.set(o,se(o,t));for(const e of r)l=o.pieces.get(e),u=a.get(e),l?u?d(l,u.piece)||(i.push(u),c.push(se(e,l))):c.push(se(e,l)):u&&i.push(u);for(const e of c)u=ie(e,i.filter((o=>d(e.piece,o.piece)))),u&&(p=[u.pos[0]-e.pos[0],u.pos[1]-e.pos[1]],t.set(e.key,p.concat(p)),n.push(u.key));for(const e of i)n.includes(e.key)||s.set(e.key,e.piece);return{anims:t,fadings:s}}(t,o);if(s.anims.size||s.fadings.size){const e=o.animation.current&&o.animation.current.start;o.animation.current={start:performance.now(),frequency:1/o.animation.duration,plan:s},e||ce(o,performance.now())}else o.dom.redraw();return n}(e,o):re(e,o)}function re(e,o){const t=e(o);return o.dom.redraw(),t}function se(e,o){return{key:e,pos:i(e),piece:o}}function ie(e,o){return o.sort(((o,t)=>l(e.pos,o.pos)-l(e.pos,t.pos)))[0]}function ce(e,o){const t=e.animation.current;if(void 0===t)return void(e.dom.destroyed||e.dom.redrawNow());const n=1-(o-t.start)*t.frequency;if(n<=0)e.animation.current=void 0,e.dom.redrawNow();else{const o=(r=n)<.5?4*r*r*r:(r-1)*(2*r-2)*(2*r-2)+1;for(const e of t.plan.anims.values())e[2]=e[0]*o,e[3]=e[1]*o;e.dom.redrawNow(!0),requestAnimationFrame(((o=performance.now())=>ce(e,o)))}var r}const ae=["green","red","blue","yellow"];function le(e,o){if(o.touches&&o.touches.length>1)return;o.stopPropagation(),o.preventDefault(),o.ctrlKey?T(e):R(e);const t=m(o),n=I(t,Y(e),e.dimensions,e.dom.bounds()),r=e.drawable.piece;n&&(e.drawable.current={orig:n,pos:t,piece:r,brush:ge(o)},de(e))}function de(e){requestAnimationFrame((()=>{const o=e.drawable.current;if(o){const t=I(o.pos,Y(e),e.dimensions,e.dom.bounds());t!==o.mouseSq&&(o.mouseSq=t,o.dest=t!==o.orig?t:void 0,o.piece=o.dest?void 0:e.drawable.piece,e.dom.redrawNow()),de(e)}}))}function ue(e,o){e.drawable.current&&(e.drawable.current.pos=m(o))}function pe(e){const o=e.drawable.current;o&&(o.mouseSq&&function(e,o){const t=e=>e.orig===o.orig&&e.dest===o.dest,n=e=>e.orig===o.orig&&e.piece&&o.piece&&(e.piece.color!==o.piece.color||e.piece.role!==o.piece.role),r=e.shapes.find(t),s=e.shapes.find(n);r&&(e.shapes=e.shapes.filter((e=>!t(e))));r&&r.brush===o.brush&&!s||e.shapes.push(o);!o.piece||r&&r.brush===o.brush&&!s||e.shapes.push({orig:o.orig,brush:o.brush});he(e)}(e.drawable,o),fe(e))}function fe(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function ge(e){const o=(e.shiftKey||e.ctrlKey)&&v(e),t=e.altKey||e.metaKey||e.getModifierState("AltGraph");return ae[(o?1:0)+(t?2:0)]}function he(e){e.onChange&&e.onChange(e.shapes)}function me(e,o){if(void 0!==o.button&&0!==o.button)return;if(o.touches&&o.touches.length>1)return;const t=e.dom.bounds(),n=m(o),r=I(n,Y(e),e.dimensions,t);if(!r)return;const s=e.pieces.get(r),c=e.selected;var a;c||!e.drawable.enabled||!e.drawable.eraseOnClick&&s&&s.color===e.turnColor||(a=e).drawable.shapes.length&&(a.drawable.shapes=[],a.dom.redraw(),he(a.drawable)),!1===o.cancelable||o.touches&&e.movable.color&&!s&&!c&&!function(e,o){const t=Y(e),n=e.dom.bounds(),r=Math.pow(n.width/e.dimensions.files,2);for(const s in e.pieces){const i=Me(s,t,e.dimensions,n);if(l(i,o)<=r)return!0}return!1}(e,n)||o.preventDefault();const d=!!e.premovable.current,u=!!e.predroppable.current||!!e.predroppable.dropDests;e.stats.ctrlKey=o.ctrlKey,e.selected&&j(e,e.selected,r)?ne((e=>F(e,r)),e):F(e,r);const g=e.selected===r,v=Se(e,r);if(s&&v&&g&&function(e,o){const t=e.pieces.get(o);return!!t&&e.draggable.enabled&&("both"===e.movable.color||e.movable.color===t.color&&(e.turnColor===t.color||e.premovable.enabled))}(e,r)){e.draggable.current={orig:r,piece:s,origPos:n,pos:n,started:e.draggable.autoDistance&&e.stats.dragged,element:v,previouslySelected:c,originTarget:o.target},v.cgDragging=!0,v.classList.add("dragging"),v.classList.remove("fix-blur");const a=e.dom.elements.ghost;a&&(a.className=`ghost ${s.color} ${s.role}`,f(a,p(e.dimensions,t)(i(r),Y(e))),h(a,!0)),be(e)}else d&&N(e),u&&x(e);e.dom.redraw()}function ve(e,o,t,n){const s="a0";e.pieces.set(s,o),T(e),e.dom.redraw();const i=m(t);e.draggable.current={orig:s,piece:o,origPos:i,pos:i,started:!0,element:()=>Se(e,s),originTarget:t.target,newPiece:!0,force:!!n},o&&function(e){var o,t;const n=e.dropmode.active?e.dropmode.piece:null===(o=e.draggable.current)||void 0===o?void 0:o.piece;return!!n&&(e.dropmode.active||"a0"===(null===(t=e.draggable.current)||void 0===t?void 0:t.orig))&&e.predroppable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}(e)&&(e.predroppable.dropDests=function(e,o,t){const n=o.color,s=o.role;return r.filter((o=>{const r=e.get(o);return!(r&&r.color===n||("pawn"===s||"lance"===s?function(e,o,t){return"sente"===t?o[1]===e.ranks.toString():"1"===o[1]}(t,o,n):"knight"===s&&function(e,o,t){return"sente"===t?o[1]===(e.ranks-1).toString()||o[1]===e.ranks.toString():"1"===o[1]||"2"===o[1]}(t,o,n)))}))}(e.pieces,o,e.dimensions)),be(e)}function be(e){requestAnimationFrame((()=>{var o;const t=e.draggable.current;if(!t)return;(null===(o=e.animation.current)||void 0===o?void 0:o.plan.anims.has(t.orig))&&(e.animation.current=void 0);const n=e.pieces.get(t.orig);if(n&&d(n,t.piece)){if(!t.started&&l(t.pos,t.origPos)>=Math.pow(e.draggable.distance,2)&&(t.started=!0),t.started){if("function"==typeof t.element){const e=t.element();if(!e)return;e.cgDragging=!0,e.classList.add("dragging"),e.classList.remove("fix-blur"),t.element=e}const o=e.dom.bounds();f(t.element,[t.pos[0]-o.left-o.width/(2*e.dimensions.files),t.pos[1]-o.top-o.height/(2*e.dimensions.ranks)])}}else ye(e);be(e)}))}function we(e,o){e.draggable.current&&(!o.touches||o.touches.length<2)&&(e.draggable.current.pos=m(o))}function ke(e,o){const t=e.draggable.current;if(!t)return;if("touchend"===o.type&&!1!==o.cancelable&&o.preventDefault(),"touchend"===o.type&&t.originTarget!==o.target&&!t.newPiece)return void(e.draggable.current=void 0);N(e),x(e);const n=I(m(o)||t.pos,Y(e),e.dimensions,e.dom.bounds());n&&t.started&&t.orig!==n?t.newPiece?q(e,t.orig,n,t.force):(e.stats.ctrlKey=o.ctrlKey,W(e,t.orig,n)&&(e.stats.dragged=!0)):t.newPiece?e.pieces.delete(t.orig):e.draggable.deleteOnDropOff&&!n&&(e.pieces.delete(t.orig),K(e.events.change)),(t.orig!==t.previouslySelected||t.orig!==n&&n)&&e.selectable.enabled||T(e),Ce(e),e.draggable.current=void 0,e.dom.redraw()}function ye(e){const o=e.draggable.current;o&&(o.newPiece&&e.pieces.delete(o.orig),e.draggable.current=void 0,T(e),Ce(e),e.dom.redraw())}function Ce(e){const o=e.dom.elements;o.ghost&&h(o.ghost,!1)}function Me(e,o,t,n){const r=i(e);return o&&(r[0]=t.files-1-r[0],r[1]=t.ranks-1-r[1]),[n.left+n.width*r[0]/t.files+n.width/(2*t.files),n.top+n.height*(t.ranks-1-r[1])/t.ranks+n.height/(2*t.ranks)]}function Se(e,o){let t=e.dom.elements.board.firstChild;for(;t;){if(t.cgKey===o&&"PIECE"===t.tagName)return t;t=t.nextSibling}}function Pe(e,t){function r(){!function(e){e.orientation=a(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}(e),t()}return{set(o){o.orientation&&o.orientation!==e.orientation&&r(),(o.fen?ne:re)((e=>ee(e,o)),e)},state:e,getFen:()=>{return t=e.pieces,n.map((e=>o.map((o=>{const n=t.get(o+e);if(n){const e=Q[n.role];return"sente"===n.color?e.toUpperCase():e}return"1"})).join(""))).join("/").replace(/1{2,}/g,(e=>e.length.toString()));var t},toggleOrientation:r,setPieces(o){ne((e=>function(e,o){for(const[t,n]of o)n?e.pieces.set(t,n):e.pieces.delete(t)}(e,o)),e)},selectSquare(o,t){o?ne((e=>F(e,o,t)),e):e.selected&&(T(e),e.dom.redraw())},move(o,t){ne((e=>O(e,o,t)),e)},newPiece(o,t){ne((e=>$(e,o,t)),e)},playPremove(){if(e.premovable.current){if(ne(G,e))return!0;e.dom.redraw()}return!1},playPredrop(o){if(e.predroppable.current){const t=function(e,o){const t=e.predroppable.current;let n=!1;if(!t)return!1;o(t)&&$(e,{role:t.role,color:e.movable.color},t.key)&&(K(e.movable.events.afterNewPiece,t.role,t.key,{predrop:!0}),n=!0);return x(e),n}(e,o);return e.dom.redraw(),t}return!1},cancelPremove(){re(N,e)},cancelPredrop(){re(x,e)},cancelMove(){re((e=>{R(e),ye(e)}),e)},stop(){re((e=>{X(e),ye(e)}),e)},setAutoShapes(o){re((e=>e.drawable.autoShapes=o),e)},setShapes(o){re((e=>e.drawable.shapes=o),e)},getKeyAtDomPos:o=>I(o,Y(e),e.dimensions,e.dom.bounds()),redrawAll:t,dragNewPiece(o,t,n){ve(e,o,t,n)},destroy(){X(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function De(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function Ae(e,o){const t=e.drawable,n=t.current,r=n&&n.mouseSq?n:void 0,s=new Map,i=e.dom.bounds();for(const e of t.shapes.concat(t.autoShapes).concat(r?[r]:[]))e.dest&&s.set(e.dest,(s.get(e.dest)||0)+1);const c=t.shapes.concat(t.autoShapes).map((e=>({shape:e,current:!1,hash:Le(e,s,!1,i)})));r&&c.push({shape:r,current:!0,hash:Le(r,s,!0,i)});const a=c.map((e=>e.hash)).join(";");if(a===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=a;const l=o.firstChild;!function(e,o,t){const n=new Map;let r;for(const t of o)t.shape.dest&&(r=e.brushes[t.shape.brush],t.shape.modifiers&&(r=Ee(r,t.shape.modifiers)),n.set(r.key,r));const s=new Set;let i=t.firstChild;for(;i;)s.add(i.getAttribute("cgKey")),i=i.nextSibling;for(const[e,o]of n.entries())s.has(e)||t.appendChild(xe(o))}(t,c,l),function(e,o,t,n,r,s){const i=e.dom.bounds(),c=new Map,a=[];for(const e of o)c.set(e.hash,!1);let l,d=s.nextSibling;for(;d;)l=d.getAttribute("cgHash"),c.has(l)?c.set(l,!0):a.push(d),d=d.nextSibling;for(const e of a)r.removeChild(e);for(const s of o)c.get(s.hash)||r.appendChild(Ne(e,s,t,n,i))}(e,c,t.brushes,s,o,l)}function Le({orig:e,dest:o,brush:t,piece:n,modifiers:r},s,i,c){return[c.width,c.height,i,e,o,t,o&&(s.get(o)||0)>1,n&&Ke(n),r&&(a=r,""+(a.lineWidth||""))].filter((e=>e)).join(",");var a}function Ke(e){return[e.color,e.role,e.scale].filter((e=>e)).join(",")}function Ne(e,{shape:o,current:t,hash:n},r,s,c){let a;if(o.piece&&!o.dest)a=function(e,o,t,n){const r=Fe(e,n,t),s=n.width/t.files*(o.scale||.8);let i=Oe(De("foreignObject"),{className:`${o.role} ${o.color}`,x:r[0]-s/2,y:r[1]-s/2,width:s,height:s}),c=b("piece",`${o.color} ${o.role}`);return c.style.width="200%",c.style.height="200%",c.style.margin="-50%",i.append(c),i}($e(i(o.orig),e.orientation,e.dimensions),o.piece,e.dimensions,c);else{const n=$e(i(o.orig),e.orientation,e.dimensions);if(o.dest){let l=r[o.brush];o.modifiers&&(l=Ee(l,o.modifiers)),a=function(e,o,t,n,r,s,i){const c=function(e,o){return(o?20:10)/512*e.width}(i,r&&!n),a=Fe(o,i,s),l=Fe(t,i,s),d=l[0]-a[0],u=l[1]-a[1],p=Math.atan2(u,d),f=Math.cos(p)*c,g=Math.sin(p)*c;return Oe(De("line"),{stroke:e.color,"stroke-width":We(e,n,i),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:qe(e,n),x1:a[0],y1:a[1],x2:l[0]-f,y2:l[1]-g})}(l,n,$e(i(o.dest),e.orientation,e.dimensions),t,(s.get(o.dest)||0)>1,e.dimensions,c)}else a=function(e,o,t,n,r){const s=Fe(o,r,n),i=function(e){const o=e.width/512;return[3*o,4*o]}(r),c=(r.width+r.height)/(4*n.files);return Oe(De("circle"),{stroke:e.color,"stroke-width":i[t?0:1],fill:"none",opacity:qe(e,t),cx:s[0],cy:s[1],r:c-i[1]/2})}(r[o.brush],n,t,e.dimensions,c)}return a.setAttribute("cgHash",n),a}function xe(e){const o=Oe(De("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return o.appendChild(Oe(De("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),o.setAttribute("cgKey",e.key),o}function Oe(e,o){for(const t in o)e.setAttribute(t,o[t]);return e}function $e(e,o,t){return"sente"===o?[t.files-1-e[0],t.ranks-1-e[1]]:e}function Ee(e,o){return{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(o.lineWidth||e.lineWidth),key:[e.key,o.lineWidth].filter((e=>e)).join("")}}function We(e,o,t){return(e.lineWidth||10)*(o?.85:1)/512*t.width}function qe(e,o){return(e.opacity||1)*(o?.9:1)}function Fe(e,o,t){return[(e[0]+.5)*o.width/t.files,(t.ranks-.5-e[1])*o.height/t.ranks]}function ze(o,t,n){o.innerHTML="",o.classList.add("cg-wrap");for(const n of e)o.classList.toggle("orientation-"+n,t.orientation===n);o.classList.toggle("manipulable",!t.viewOnly);const r=b("cg-container");o.appendChild(r);const s=b("cg-board");let i;var c;let a,l;if(r.appendChild(s),c=o,Array.from(c.classList).includes("mini-board")?t.pockets?(i=[b("cg-pocket"),b("cg-pocket")],r.insertBefore(i["sente"===t.orientation?1:0],s),r.insertBefore(i["sente"===t.orientation?0:1],s.nextSibling)):o.classList.add("no-pockets"):delete t.pockets,t.drawable.visible&&!n&&(a=De("svg"),a.appendChild(De("defs")),r.appendChild(a)),t.coordinates){const e="gote"===t.orientation?" gote":"";0===t.notation||1===t.notation?r.appendChild(Te(["9","8","7","6","5","4","3","2","1"],"ranks"+e,t.dimensions.ranks)):3===t.notation?r.appendChild(Te(["i","h","g","f","e","d","c","b","a"],"ranks"+e,t.dimensions.ranks)):r.appendChild(Te(["九","八","七","六","五","四","三","二","一"],"ranks"+e,t.dimensions.ranks)),r.appendChild(Te(["9","8","7","6","5","4","3","2","1"],"files"+e,t.dimensions.files))}return t.draggable.showGhost&&!n&&(l=b("piece","ghost"),h(l,!1),r.appendChild(l)),{pockets:i,board:s,container:r,ghost:l,svg:a}}function Te(e,o,t){const n=b("coords",o);let r;for(const o of e.slice(-t))r=b("coord"),r.textContent=o,n.appendChild(r);return n}function Be(e,o){const t=e.dom.elements.board;if(!e.dom.relative&&e.resizable&&"ResizeObserver"in window&&new ResizeObserver(o).observe(t),e.viewOnly)return;const n=function(e){return o=>{e.draggable.current?ye(e):e.drawable.current?fe(e):o.shiftKey||v(o)?e.drawable.enabled&&le(e,o):e.viewOnly||(e.dropmode.active&&!function(e,o){const t=m(o),n=t&&I(t,Y(e),e.dimensions,e.dom.bounds());return!(!n||!e.pieces.has(n))}(e,o)?function(e,o){if(!e.dropmode.active)return;N(e),x(e);const t=e.dropmode.piece;if(t){e.pieces.set("a0",t);const n=m(o),r=n&&I(n,Y(e),e.dimensions,e.dom.bounds());r&&q(e,"a0",r)}e.dom.redraw()}(e,o):(!function(e){e.dropmode.active=!1,e.dropmode.piece=void 0}(e),me(e,o)))}}(e);t.addEventListener("touchstart",n,{passive:!1}),t.addEventListener("mousedown",n,{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&t.addEventListener("contextmenu",(e=>e.preventDefault()))}function je(e,o,t,n){return e.addEventListener(o,t,n),()=>e.removeEventListener(o,t,n)}function He(e,o,t){return n=>{e.drawable.current?e.drawable.enabled&&t(e,n):e.viewOnly||o(e,n)}}function Ge(e){const o=Y(e),t=e.dom.relative?(C=e.dimensions,(e,o)=>u(e,C,o,50,50)):p(e.dimensions,e.dom.bounds()),n=e.dom.relative?g:f,r=e.dom.elements.board,s=e.dom.elements.pockets,c=e.pieces,a=e.animation.current,l=a?a.plan.anims:new Map,d=a?a.plan.fadings:new Map,h=e.draggable.current,m=function(e){var o,t,n,r;const s=new Map;if(e.lastMove&&e.highlight.lastMove)for(const o of e.lastMove)o.includes("*")||Ue(s,o,"last-move");e.check&&e.highlight.check&&Ue(s,e.check,"check");if(e.selected){if(Ue(s,e.selected,"selected"),e.movable.showDests){const t=null===(o=e.movable.dests)||void 0===o?void 0:o.get(e.selected);if(t)for(const o of t)Ue(s,o,"move-dest"+(e.pieces.has(o)?" oc":""));const n=e.premovable.dests;if(n)for(const o of n)Ue(s,o,"premove-dest"+(e.pieces.has(o)?" oc":""))}}else if(e.dropmode.active||"a0"===(null===(t=e.draggable.current)||void 0===t?void 0:t.orig)){const o=e.dropmode.active?e.dropmode.piece:null===(n=e.draggable.current)||void 0===n?void 0:n.piece;if(o&&e.dropmode.showDropDests){const t=null===(r=e.dropmode.dropDests)||void 0===r?void 0:r.get(o.role);if(t)for(const e of t)Ue(s,e,"move-dest");const n=e.predroppable.dropDests;if(n&&!t)for(const o of n)Ue(s,o,"premove-dest"+(e.pieces.has(o)?" oc":""))}}const i=e.premovable.current;if(i)for(const e of i)Ue(s,e,"current-premove");else e.predroppable.current&&Ue(s,e.predroppable.current.key,"current-premove");return s}(e),v=new Set,w=new Set,k=new Map,y=new Map;var C;let M,S,P,D,A,L,K,N,x,O;for(S=r.firstChild;S;){if(M=S.cgKey,Re(S))if(P=c.get(M),A=l.get(M),L=d.get(M),D=S.cgPiece,S.classList.remove("fix-blur"),"a0"===M&&S.classList.add("fix-blur"),!S.cgDragging||h&&h.orig===M||(S.classList.remove("dragging"),n(S,t(i(M),o)),S.cgDragging=!1),!L&&S.cgFading&&(S.cgFading=!1,S.classList.remove("fading")),P){if(A&&S.cgAnimating&&D===Ye(P)){const e=i(M);e[0]+=A[2],e[1]+=A[3],S.classList.add("anim"),n(S,t(e,o))}else S.cgAnimating&&(S.cgAnimating=!1,S.classList.remove("anim"),n(S,t(i(M),o)));D!==Ye(P)||L&&S.cgFading?L&&D===Ye(L)?(S.classList.add("fading"),S.cgFading=!0):Je(k,D,S):v.add(M)}else Je(k,D,S);else if(Xe(S)){const e=S.className;m.get(M)===e?w.add(M):Je(y,e,S)}S=S.nextSibling}for(const[e,s]of m)if(!w.has(e)){x=y.get(s),O=x&&x.pop();const c=t(i(e),o);if(O)O.cgKey=e,n(O,c,!1);else{const o=b("square",s);o.cgKey=e,n(o,c,!1),r.insertBefore(o,r.firstChild)}}for(const[e,s]of c)if(A=l.get(e),!v.has(e))if(K=k.get(Ye(s)),N=K&&K.pop(),N){N.cgKey=e,N.cgFading&&(N.classList.remove("fading"),N.cgFading=!1);const r=i(e);A&&(N.cgAnimating=!0,N.classList.add("anim"),r[0]+=A[2],r[1]+=A[3]),n(N,t(r,o))}else{const c=Ye(s),a=b("piece",c),l=i(e);a.cgPiece=c,a.cgKey=e,A&&(a.cgAnimating=!0,l[0]+=A[2],l[1]+=A[3]),n(a,t(l,o)),r.appendChild(a)}if(e.pockets&&s)for(const o of[0,1]){const t=(s[o].firstElementChild||_(e,s[o],0===o?"sente":"gote")).getElementsByTagName("piece");for(let n=0;n<t.length;n++){const r=t[n].getAttribute("data-role");t[n].setAttribute("data-nb",e.pockets[o][r||""])}}for(const o of k.values())Ie(e,o);for(const o of y.values())Ie(e,o)}function Re(e){return"PIECE"===e.tagName}function Xe(e){return"SQUARE"===e.tagName}function Ie(e,o){for(const t of o)e.dom.elements.board.removeChild(t)}function Ye(e){return`${e.color} ${e.role}`}function Ue(e,o,t){const n=e.get(o);n?e.set(o,`${n} ${t}`):e.set(o,t)}function Je(e,o,t){const n=e.get(o);n?n.push(t):e.set(o,[t])}function Qe(e){let o=!1;return()=>{o||(o=!0,requestAnimationFrame((()=>{e(),o=!1})))}}return function(e,o){const t={pieces:V(U,{files:9,ranks:9}),orientation:"sente",turnColor:"sente",coordinates:!0,viewOnly:!1,disableContextMenu:!1,resizable:!0,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{}},premovable:{enabled:!0,showDests:!0,events:{}},predroppable:{enabled:!0,showDropDests:!0,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1,showDropDests:!0},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},prevSvgHash:""},hold:c(),notation:0,dimensions:{files:9,ranks:9}};function n(){const o=t.dom&&t.dom.unbind,n=t.viewOnly&&!t.drawable.visible,r=ze(e,t,n),s=function(e){let o;const t=()=>(void 0===o&&(o=e()),o);return t.clear=()=>{o=void 0},t}((()=>r.board.getBoundingClientRect())),c=e=>{Ge(t),!e&&r.svg&&Ae(t,r.svg)},a=()=>{s.clear(),function(e){if(e.dom.relative)return;const o=Y(e),t=p(e.dimensions,e.dom.bounds());let n=e.dom.elements.board.firstChild;for(;n;)Re(n)&&!n.cgAnimating?f(n,t(i(n.cgKey),o)):Xe(n)&&f(n,t(i(n.cgKey),o),!1),n=n.nextSibling}(t),r.svg&&Ae(t,r.svg)};t.dom={elements:r,bounds:s,redraw:Qe(c),redrawNow:c,unbind:o,relative:n},t.drawable.prevSvgHash="",c(!1),Be(t,a),o||(t.dom.unbind=function(e,o){const t=[];if(e.dom.relative||!e.resizable||"ResizeObserver"in window||t.push(je(document.body,"shogiground.resize",o)),!e.viewOnly){const o=He(e,we,ue),n=He(e,ke,pe);for(const e of["touchmove","mousemove"])t.push(je(document,e,o));for(const e of["touchend","mouseup"])t.push(je(document,e,n));const r=()=>e.dom.bounds.clear();t.push(je(document,"scroll",r,{capture:!0,passive:!0})),t.push(je(window,"resize",r,{passive:!0}))}return()=>t.forEach((e=>e()))}(t,a)),t.events.insert&&t.events.insert(r)}return ee(t,o||{}),n(),Pe(t,n)}}();
