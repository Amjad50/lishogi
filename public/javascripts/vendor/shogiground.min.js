var Shogiground=function(){"use strict";function e(e,t,o){return e(o={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&o.path)}},o.exports),o.exports}var t=e((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ranks=t.files=t.colors=void 0,t.colors=["white","black"],t.files=["a","b","c","d","e","f","g","h","i"],t.ranks=["1","2","3","4","5","6","7","8","9"]})),o=e((function(e,o){Object.defineProperty(o,"__esModule",{value:!0}),o.droppableRoles=o.isMiniBoard=o.createEl=o.isRightButton=o.eventPosition=o.setVisible=o.translateRel=o.translateAbs=o.posToTranslateRel=o.posToTranslateAbs=o.validProm=o.samePiece=o.distanceSq=o.opposite=o.timer=o.memo=o.key2pos=o.pos2key=o.allKeys=o.invRanks=void 0,o.invRanks=["9","8","7","6","5","4","3","2","1"];const n={rook:"dragon",bishop:"horse",silver:"promotedSilver",knight:"promotedKnight",lance:"promotedLance",pawn:"tokin"};o.allKeys=Array.prototype.concat(...t.files.map(e=>t.ranks.map(t=>e+t))),o.pos2key=e=>o.allKeys[9*e[0]+e[1]],o.key2pos=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],o.memo=function(e){let t;const o=()=>(void 0===t&&(t=e()),t);return o.clear=()=>{t=void 0},o},o.timer=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},o.opposite=e=>"white"===e?"black":"white",o.distanceSq=(e,t)=>{const o=e[0]-t[0],n=e[1]-t[1];return o*o+n*n},o.samePiece=(e,t)=>e.role===t.role&&e.color===t.color,o.validProm=(e,t)=>e.color===t.color&&(n[e.role]==t.role||n[t.role]==e.role);const r=(e,t,o,n)=>[(t?e[0]:8-e[0])*o,(t?8-e[1]:e[1])*n];o.posToTranslateAbs=e=>{const t=e.width/9,o=e.height/9;return(e,n)=>r(e,n,t,o)},o.posToTranslateRel=(e,t)=>r(e,t,100,100),o.translateAbs=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},o.translateRel=(e,t)=>{e.style.transform=`translate(${t[0]}%,${t[1]}%)`},o.setVisible=(e,t)=>{e.style.visibility=t?"visible":"hidden"},o.eventPosition=e=>e.clientX||0===e.clientX?[e.clientX,e.clientY]:e.touches&&e.targetTouches[0]?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0,o.isRightButton=e=>2===e.buttons||2===e.button,o.createEl=(e,t)=>{const o=document.createElement(e);return t&&(o.className=t),o},o.isMiniBoard=e=>Array.from(e.classList).includes("mini-board"),o.droppableRoles=["pawn","lance","knight","silver","gold","bishop","rook"]})),n=e((function(e,t){function n(e,t){return Math.abs(e-t)}Object.defineProperty(t,"__esModule",{value:!0}),t.premove=void 0;const r=(e,t,o,r)=>n(e,o)===n(t,r),i=(e,t,o,n)=>e===o||t===n,s=(e,t,o,r)=>n(e,o)<2&&n(t,r)<2;const a=(e,t,o,n)=>s(e,t,o,n)||r(e,t,o,n),c=(e,t,o,n)=>s(e,t,o,n)||i(e,t,o,n),l=o.allKeys.map(o.key2pos);t.premove=function(e,t){const d=e.get(t);if(!d)return[];const u=o.key2pos(t),p=d.role,f="pawn"===p?(g=d.color,(e,t,o,n)=>"white"===g?e===o&&t+1===n:e===o&&t-1===n):"knight"===p?function(e){return(t,o,r,i)=>1===n(t,r)&&2===n(o,i)&&("white"===e?i>o:i<o)}(d.color):"bishop"===p?r:"rook"===p?i:"king"===p?s:"silver"===p?function(e){return(t,o,r,i)=>n(t,r)<2&&n(o,i)<2&&o!=i&&("white"===e?t!=r||i>o:t!=r||i<o)}(d.color):"lance"===p?function(e){return(t,o,n,r)=>"white"===e?t==n&&r>o:t==n&&o>r}(d.color):"horse"===p?a:"dragon"===p?c:function(e){return(t,o,r,i)=>n(t,r)<2&&n(o,i)<2&&("white"===e?i>=o||t==r:i<=o||t==r)}(d.color);var g;return l.filter(e=>(u[0]!==e[0]||u[1]!==e[1])&&f(u[0],u[1],e[0],e[1])).map(o.pos2key)}})),r=e((function(e,t){function r(e,...t){e&&setTimeout(()=>e(...t),1)}function i(e){e.premovable.current&&(e.premovable.current=void 0,r(e.premovable.events.unset))}function s(e){const t=e.predroppable;t.current&&(t.current=void 0,r(t.events.unset))}function a(e,t,n){const i=e.pieces.get(t),s=e.pieces.get(n);if(t===n||!i)return!1;const a=s&&s.color!==i.color?s:void 0;return n===e.selected&&p(e),r(e.events.move,t,n,a),function(e,t,n){if(!e.autoCastle)return!1;const r=e.pieces.get(t);if(!r||"king"!==r.role)return!1;const i=o.key2pos(t),s=o.key2pos(n);if(0!==i[1]&&7!==i[1]||i[1]!==s[1])return!1;4!==i[0]||e.pieces.has(n)||(6===s[0]?n=o.pos2key([7,s[1]]):2===s[0]&&(n=o.pos2key([0,s[1]])));const a=e.pieces.get(n);return!(!a||a.color!==r.color||"rook"!==a.role)&&(e.pieces.delete(t),e.pieces.delete(n),i[0]<s[0]?(e.pieces.set(o.pos2key([6,s[1]]),r),e.pieces.set(o.pos2key([5,s[1]]),a)):(e.pieces.set(o.pos2key([2,s[1]]),r),e.pieces.set(o.pos2key([3,s[1]]),a)),!0)}(e,t,n)||(e.pieces.set(n,i),e.pieces.delete(t)),e.lastMove=[t,n],e.check=void 0,r(e.events.change),a||!0}function c(e,t,n,i){if(e.pieces.has(n)){if(!i)return!1;e.pieces.delete(n)}return r(e.events.dropNewPiece,t,n),e.pieces.set(n,t),e.lastMove=[n],e.check=void 0,r(e.events.change),e.movable.dests=void 0,e.turnColor=o.opposite(e.turnColor),!0}function l(e,t,n){const r=a(e,t,n);return r&&(e.movable.dests=void 0,e.turnColor=o.opposite(e.turnColor),e.animation.current=void 0),r}function d(e,t,o){if(g(e,t,o)){const n=l(e,t,o);if(n){const i=e.hold.stop();p(e);const s={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:i};return!0!==n&&(s.captured=n),r(e.movable.events.after,t,o,s),!0}}else if(function(e,t,o){return t!==o&&h(e,t)&&n.premove(e.pieces,t).includes(o)}(e,t,o))return function(e,t,o,n){s(e),e.premovable.current=[t,o],r(e.premovable.events.set,t,o,n)}(e,t,o,{ctrlKey:e.stats.ctrlKey}),p(e),!0;return p(e),!1}function u(e,t){e.selected=t,h(e,t)?e.premovable.dests=n.premove(e.pieces,t):e.premovable.dests=void 0}function p(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function f(e,t){const o=e.pieces.get(t);return!!o&&("both"===e.movable.color||e.movable.color===o.color&&e.turnColor===o.color)}function g(e,t,o){var n,r;return t!==o&&f(e,t)&&(e.movable.free||!!(null===(r=null===(n=e.movable.dests)||void 0===n?void 0:n.get(t))||void 0===r?void 0:r.includes(o)))}function h(e,t){const o=e.pieces.get(t);return!!o&&e.premovable.enabled&&e.movable.color===o.color&&e.turnColor!==o.color}function v(e){i(e),s(e),p(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.whitePov=t.getKeyAtDomPos=t.stop=t.cancelMove=t.playPredrop=t.playPremove=t.isDraggable=t.canMove=t.unselect=t.setSelected=t.selectSquare=t.dropNewPiece=t.userMove=t.baseNewPiece=t.baseMove=t.unsetPredrop=t.unsetPremove=t.setCheck=t.setPieces=t.reset=t.toggleOrientation=t.callUserFunction=void 0,t.callUserFunction=r,t.toggleOrientation=function(e){e.orientation=o.opposite(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0},t.reset=function(e){e.lastMove=void 0,p(e),i(e),s(e)},t.setPieces=function(e,t){for(const[o,n]of t)n?e.pieces.set(o,n):e.pieces.delete(o)},t.setCheck=function(e,t){if(e.check=void 0,!0===t&&(t=e.turnColor),t)for(const[o,n]of e.pieces)"king"===n.role&&n.color===t&&(e.check=o)},t.unsetPremove=i,t.unsetPredrop=s,t.baseMove=a,t.baseNewPiece=c,t.userMove=d,t.dropNewPiece=function(e,t,o,n){const a=e.pieces.get(t);a&&(function(e,t,o){const n=e.pieces.get(t);return!(!n||t!==o&&e.pieces.has(o)||"both"!==e.movable.color&&(e.movable.color!==n.color||e.turnColor!==n.color))}(e,t,o)||n)?(e.pieces.delete(t),c(e,a,o,n),r(e.movable.events.afterNewPiece,a.role,o,{predrop:!1})):a&&function(e,t,o){const n=e.pieces.get(t),r=e.pieces.get(o);return!!n&&(!r||r.color!==e.movable.color)&&e.predroppable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}(e,t,o)?function(e,t,o){i(e),e.predroppable.current={role:t,key:o},r(e.predroppable.events.set,t,o)}(e,a.role,o):(i(e),s(e)),e.pieces.delete(t),p(e)},t.selectSquare=function(e,t,o){if(r(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled)return p(e),void e.hold.cancel();if((e.selectable.enabled||o)&&e.selected!==t&&d(e,e.selected,t))return void(e.stats.dragged=!1)}(f(e,t)||h(e,t))&&(u(e,t),e.hold.start())},t.setSelected=u,t.unselect=p,t.canMove=g,t.isDraggable=function(e,t){const o=e.pieces.get(t);return!!o&&e.draggable.enabled&&("both"===e.movable.color||e.movable.color===o.color&&(e.turnColor===o.color||e.premovable.enabled))},t.playPremove=function(e){const t=e.premovable.current;if(!t)return!1;const o=t[0],n=t[1];let s=!1;if(g(e,o,n)){const t=l(e,o,n);if(t){const i={premove:!0};!0!==t&&(i.captured=t),r(e.movable.events.after,o,n,i),s=!0}}return i(e),s},t.playPredrop=function(e,t){const o=e.predroppable.current;let n=!1;if(!o)return!1;if(t(o)){c(e,{role:o.role,color:e.movable.color},o.key)&&(r(e.movable.events.afterNewPiece,o.role,o.key,{predrop:!0}),n=!0)}return s(e),n},t.cancelMove=v,t.stop=function(e){e.movable.color=e.movable.dests=e.animation.current=void 0,v(e)},t.getKeyAtDomPos=function(e,t,n){let r=Math.floor(9*(e[0]-n.left)/n.width);t||(r=8-r);let i=8-Math.floor(9*(e[1]-n.top)/n.height);return t||(i=8-i),r>=0&&r<9&&i>=0&&i<9?o.pos2key([r,i]):void 0},t.whitePov=function(e){return"white"===e.orientation}})),i=e((function(e,n){Object.defineProperty(n,"__esModule",{value:!0}),n.write=n.read=n.initial=void 0,n.initial="lnsgkgsnl/1r5b1/ppppppppp/9/9/9/PPPPPPPPP/1B5R1/LNSGKGSNL";const r={p:"pawn",l:"lance",n:"knight",s:"silver",g:"gold",b:"bishop",r:"rook",k:"king","+p":"tokin",t:"tokin","+l":"promotedLance",u:"promotedLance","+n":"promotedKnight",m:"promotedKnight","+s":"promotedSilver",a:"promotedSilver","+b":"horse",h:"horse","+r":"dragon",d:"dragon"},i={pawn:"p",lance:"l",knight:"n",silver:"s",gold:"g",bishop:"b",rook:"r",king:"k",tokin:"t",promotedLance:"u",promotedKnight:"m",promotedSilver:"a",horse:"h",dragon:"d"};n.read=function(e){"start"===e&&(e=n.initial);const t=new Map;let i=8,s=0;for(let n=0;n<e.length;n++)switch(e[n]){case" ":case"_":return t;case"/":if(--i,i<0)return t;s=0;break;case"~":const a=t.get(o.pos2key([s,i]));a&&(a.promoted=!0);break;default:const c=e[n].charCodeAt(0);if(c<58&&43!=c)s+=c-48;else{const a="+"===e[n]&&e.length>n+1?"+"+e[++n].toLowerCase():e[n].toLowerCase(),c=e[n]===a||"+"+e[n]===a?"black":"white";t.set(o.pos2key([s,i]),{role:r[a],color:c}),++s}}return t},n.write=function(e){return o.invRanks.map(o=>t.files.map(t=>{const n=e.get(t+o);if(n){const e=i[n.role];return"white"===n.color?e.toUpperCase():e}return"1"}).join("")).join("/").replace(/1{2,}/g,e=>e.length.toString())}})),s=e((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.addPocketEl=t.makePockets=void 0;const n={p:"pawn",l:"lance",n:"knight",s:"silver",g:"gold",b:"bishop",r:"rook"};t.makePockets=function(e){if(void 0===e)return;const t=[{pawn:0,lance:0,knight:0,silver:0,gold:0,bishop:0,rook:0},{pawn:0,lance:0,knight:0,silver:0,gold:0,bishop:0,rook:0}];if(e){let o=0;for(const r of e){const e=n[r.toLowerCase()];e?(t[r.toLowerCase()===r?1:0][e]+=o||1,o=0):o=10*o+Number(r)}}return t},t.addPocketEl=function(e,t,n){const r="white"===e.orientation!=("white"==n)?"top":"bottom",i=o.createEl("div","pocket is2d pocket-"+r);t.appendChild(i);for(const s of o.droppableRoles){const e=o.createEl("div","pocket-c1");i.appendChild(e);const t=o.createEl("div","pocket-c2");e.appendChild(t);const r=o.createEl("piece",s+" "+n);r.setAttribute("data-role",s),r.setAttribute("data-color",n),r.setAttribute("data-nb","0"),t.appendChild(r)}return i}})),a=e((function(e,t){function o(e){return"object"==typeof e}Object.defineProperty(t,"__esModule",{value:!0}),t.configure=void 0,t.configure=function(e,t){var n;if((null===(n=t.movable)||void 0===n?void 0:n.dests)&&(e.movable.dests=void 0),function e(t,n){for(const r in n)o(t[r])&&o(n[r])?e(t[r],n[r]):t[r]=n[r]}(e,t),t.fen&&(e.pieces=i.read(t.fen),e.drawable.shapes=[]),e.pockets=s.makePockets(t.pockets),t.hasOwnProperty("check")&&r.setCheck(e,t.check||!1),t.hasOwnProperty("lastMove")&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&r.setSelected(e,e.selected),(!e.animation.duration||e.animation.duration<100)&&(e.animation.enabled=!1),!e.movable.rookCastle&&e.movable.dests){const t="white"===e.movable.color?"1":"9",o="e"+t,n=e.movable.dests.get(o),r=e.pieces.get(o);if(!n||!r||"king"!==r.role)return;e.movable.dests.set(o,n.filter(e=>!(e==="a"+t&&n.includes("c"+t)||e==="h"+t&&n.includes("g"+t))))}}})),c=e((function(e,t){function n(e,t){const o=e(t);return t.dom.redraw(),o}function r(e,t){return{key:e,pos:o.key2pos(e),piece:t}}function i(e,t){return t.sort((t,n)=>o.distanceSq(e.pos,t.pos)-o.distanceSq(e.pos,n.pos))[0]}Object.defineProperty(t,"__esModule",{value:!0}),t.render=t.anim=void 0,t.anim=function(e,t){return t.animation.enabled?function(e,t){const n=new Map(t.pieces),s=e(t),a=function(e,t){const n=new Map,s=[],a=new Map,c=[],l=[],d=new Map;let u,p,f;for(const[o,i]of e)d.set(o,r(o,i));for(const i of o.allKeys)u=t.pieces.get(i),p=d.get(i),u?p?o.samePiece(u,p.piece)||(c.push(p),l.push(r(i,u))):l.push(r(i,u)):p&&c.push(p);for(const r of l)p=i(r,c.filter(e=>o.samePiece(r.piece,e.piece))),p&&(f=[p.pos[0]-r.pos[0],p.pos[1]-r.pos[1]],n.set(r.key,f.concat(f)),s.push(p.key));for(const o of c)s.includes(o.key)||a.set(o.key,o.piece);return{anims:n,fadings:a}}(n,t);if(a.anims.size||a.fadings.size){const e=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:a},e||function e(t,o){const n=t.animation.current;if(void 0===n)return void(t.dom.destroyed||t.dom.redrawNow());const r=1-(o-n.start)*n.frequency;if(r<=0)t.animation.current=void 0,t.dom.redrawNow();else{const o=(i=r)<.5?4*i*i*i:(i-1)*(2*i-2)*(2*i-2)+1;for(const e of n.plan.anims.values())e[2]=e[0]*o,e[3]=e[1]*o;t.dom.redrawNow(!0),requestAnimationFrame((o=performance.now())=>e(t,o))}var i}(t,performance.now())}else t.dom.redraw();return s}(e,t):n(e,t)},t.render=n})),l=e((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.clear=t.cancel=t.end=t.move=t.processDraw=t.start=void 0;const n=["green","red","blue","yellow"];function i(e){requestAnimationFrame(()=>{const t=e.drawable.current;if(t){const o=r.getKeyAtDomPos(t.pos,r.whitePov(e),e.dom.bounds());o!==t.mouseSq&&(t.mouseSq=o,t.dest=o!==t.orig?o:void 0,t.piece=t.dest?void 0:e.drawable.piece,e.dom.redrawNow()),i(e)}})}function s(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function a(e){const t=(e.shiftKey||e.ctrlKey)&&o.isRightButton(e),r=e.altKey||e.metaKey||e.getModifierState("AltGraph");return n[(t?1:0)+(r?2:0)]}function c(e){e.onChange&&e.onChange(e.shapes)}t.start=function(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?r.unselect(e):r.cancelMove(e);const n=o.eventPosition(t),s=r.getKeyAtDomPos(n,r.whitePov(e),e.dom.bounds()),c=e.drawable.piece;s&&(e.drawable.current={orig:s,pos:n,piece:c,brush:a(t)},i(e))},t.processDraw=i,t.move=function(e,t){e.drawable.current&&(e.drawable.current.pos=o.eventPosition(t))},t.end=function(e){const t=e.drawable.current;t&&(t.mouseSq&&function(e,t){const o=e=>e.orig===t.orig&&e.dest===t.dest,n=e.shapes.find(o),r=e.shapes.find(e=>e.orig===t.orig&&e.piece&&t.piece&&(e.piece.color!==t.piece.color||e.piece.role!==t.piece.role));n&&(e.shapes=e.shapes.filter(e=>!o(e)));n&&n.brush===t.brush&&!r||e.shapes.push(t);!t.piece||n&&n.brush===t.brush&&!r||e.shapes.push({orig:t.orig,brush:t.brush});c(e)}(e.drawable,t),s(e))},t.cancel=s,t.clear=function(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),c(e.drawable))}})),d=e((function(e,t){function n(e){requestAnimationFrame(()=>{var t;const r=e.draggable.current;if(!r)return;(null===(t=e.animation.current)||void 0===t?void 0:t.plan.anims.has(r.orig))&&(e.animation.current=void 0);const s=e.pieces.get(r.orig);if(s&&o.samePiece(s,r.piece)){if(!r.started&&o.distanceSq(r.pos,r.origPos)>=Math.pow(e.draggable.distance,2)&&(r.started=!0),r.started){if("function"==typeof r.element){const e=r.element();if(!e)return;e.cgDragging=!0,e.classList.add("dragging"),e.classList.remove("fix-blur"),r.element=e}const t=e.dom.bounds();o.translateAbs(r.element,[r.pos[0]-t.left-t.width/18,r.pos[1]-t.top-t.height/18])}}else i(e);n(e)})}function i(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,r.unselect(e),s(e),e.dom.redraw())}function s(e){const t=e.dom.elements;t.ghost&&o.setVisible(t.ghost,!1)}function a(e,t,n){const r=o.key2pos(e);return t||(r[0]=8-r[0],r[1]=8-r[1]),[n.left+n.width*r[0]/9+n.width/18,n.top+n.height*(8-r[1])/9+n.height/18]}function d(e,t){let o=e.dom.elements.board.firstChild;for(;o;){if(o.cgKey===t&&"PIECE"===o.tagName)return o;o=o.nextSibling}}Object.defineProperty(t,"__esModule",{value:!0}),t.cancel=t.end=t.move=t.dragNewPiece=t.start=void 0,t.start=function(e,t){if(void 0!==t.button&&0!==t.button)return;if(t.touches&&t.touches.length>1)return;const i=e.dom.bounds(),s=o.eventPosition(t),u=r.getKeyAtDomPos(s,r.whitePov(e),i);if(!u)return;const p=e.pieces.get(u),f=e.selected;f||!e.drawable.enabled||!e.drawable.eraseOnClick&&p&&p.color===e.turnColor||l.clear(e),!1===t.cancelable||t.touches&&e.movable.color&&!p&&!f&&!function(e,t){const n=r.whitePov(e),i=e.dom.bounds(),s=Math.pow(i.width/9,2);for(const r in e.pieces){const e=a(r,n,i);if(o.distanceSq(e,t)<=s)return!0}return!1}(e,s)||t.preventDefault();const g=!!e.premovable.current,h=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&r.canMove(e,e.selected,u)?c.anim(e=>r.selectSquare(e,u),e):r.selectSquare(e,u);const v=e.selected===u,m=d(e,u);if(p&&m&&v&&r.isDraggable(e,u)){e.draggable.current={orig:u,piece:p,origPos:s,pos:s,started:e.draggable.autoDistance&&e.stats.dragged,element:m,previouslySelected:f,originTarget:t.target},m.cgDragging=!0,m.classList.add("dragging"),m.classList.remove("fix-blur");const a=e.dom.elements.ghost;a&&(a.className=`ghost ${p.color} ${p.role}`,o.translateAbs(a,o.posToTranslateAbs(i)(o.key2pos(u),r.whitePov(e))),o.setVisible(a,!0)),n(e)}else g&&r.unsetPremove(e),h&&r.unsetPredrop(e);e.dom.redraw()},t.dragNewPiece=function(e,t,r,i){e.pieces.set("a0",t),e.dom.redraw();const s=o.eventPosition(r);e.draggable.current={orig:"a0",piece:t,origPos:s,pos:s,started:!0,element:()=>d(e,"a0"),originTarget:r.target,newPiece:!0,force:!!i},n(e)},t.move=function(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=o.eventPosition(t))},t.end=function(e,t){const n=e.draggable.current;if(!n)return;if("touchend"===t.type&&!1!==t.cancelable&&t.preventDefault(),"touchend"===t.type&&n.originTarget!==t.target&&!n.newPiece)return void(e.draggable.current=void 0);r.unsetPremove(e),r.unsetPredrop(e);const i=o.eventPosition(t)||n.pos,a=r.getKeyAtDomPos(i,r.whitePov(e),e.dom.bounds());a&&n.started&&n.orig!==a?n.newPiece?r.dropNewPiece(e,n.orig,a,n.force):(e.stats.ctrlKey=t.ctrlKey,r.userMove(e,n.orig,a)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!a&&(e.pieces.delete(n.orig),r.callUserFunction(e.events.change)),(n.orig!==n.previouslySelected||n.orig!==a&&a)&&e.selectable.enabled||r.unselect(e),s(e),e.draggable.current=void 0,e.dom.redraw()},t.cancel=i})),u=e((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.start=void 0,t.start=function(e,t){function o(){r.toggleOrientation(e),t()}return{set(t){t.orientation&&t.orientation!==e.orientation&&o(),(t.fen?c.anim:c.render)(e=>a.configure(e,t),e)},state:e,getFen:()=>i.write(e.pieces),toggleOrientation:o,setPieces(t){c.anim(e=>r.setPieces(e,t),e)},selectSquare(t,o){t?c.anim(e=>r.selectSquare(e,t,o),e):e.selected&&(r.unselect(e),e.dom.redraw())},move(t,o){c.anim(e=>r.baseMove(e,t,o),e)},newPiece(t,o){c.anim(e=>r.baseNewPiece(e,t,o),e)},playPremove(){if(e.premovable.current){if(c.anim(r.playPremove,e))return!0;e.dom.redraw()}return!1},playPredrop(t){if(e.predroppable.current){const o=r.playPredrop(e,t);return e.dom.redraw(),o}return!1},cancelPremove(){c.render(r.unsetPremove,e)},cancelPredrop(){c.render(r.unsetPredrop,e)},cancelMove(){c.render(e=>{r.cancelMove(e),d.cancel(e)},e)},stop(){c.render(e=>{r.stop(e),d.cancel(e)},e)},setAutoShapes(t){c.render(e=>e.drawable.autoShapes=t,e)},setShapes(t){c.render(e=>e.drawable.shapes=t,e)},getKeyAtDomPos:t=>r.getKeyAtDomPos(t,r.whitePov(e),e.dom.bounds()),redrawAll:t,dragNewPiece(t,o,n){d.dragNewPiece(e,t,o,n)},destroy(){r.stop(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}})),p=e((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.defaults=void 0,t.defaults=function(){return{pieces:i.read(i.initial),orientation:"white",turnColor:"white",coordinates:!0,autoCastle:!0,viewOnly:!1,disableContextMenu:!1,resizable:!0,addPieceZIndex:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},pieces:{baseUrl:"https://lishogi.org/assets/piece/cburnett/"},prevSvgHash:""},hold:o.timer()}}})),f=e((function(e,t){function n(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function r({orig:e,dest:t,brush:o,piece:n,modifiers:r},s,a,c){return[c.width,c.height,a,e,t,o,t&&(s.get(t)||0)>1,n&&i(n),r&&(l=r,""+(l.lineWidth||""))].filter(e=>e).join(",");var l}function i(e){return[e.color,e.role,e.scale].filter(e=>e).join(",")}function s(e,{shape:t,current:r,hash:i},s,a,g){let h;if(t.piece&&!t.dest)h=function(e,t,r){const i=f(e,r),s=r.width/9*(t.scale||.8);let a=c(n("foreignObject"),{className:`${t.role} ${t.color}`,x:i[0]-s/2,y:i[1]-s/2,width:s,height:s}),l=o.createEl("piece",`${t.color} ${t.role}`);return l.style.width="100%",l.style.height="100%",a.append(l),a}(l(o.key2pos(t.orig),e.orientation),t.piece,g);else{const i=l(o.key2pos(t.orig),e.orientation);if(t.dest){let v=s[t.brush];t.modifiers&&(v=d(v,t.modifiers)),h=function(e,t,o,r,i,s){const a=function(e,t){return(t?20:10)/512*e.width}(s,i&&!r),l=f(t,s),d=f(o,s),g=d[0]-l[0],h=d[1]-l[1],v=Math.atan2(h,g),m=Math.cos(v)*a,b=Math.sin(v)*a;return c(n("line"),{stroke:e.color,"stroke-width":u(e,r,s),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:p(e,r),x1:l[0],y1:l[1],x2:d[0]-m,y2:d[1]-b})}(v,i,l(o.key2pos(t.dest),e.orientation),r,(a.get(t.dest)||0)>1,g)}else h=function(e,t,o,r){const i=f(t,r),s=function(e){const t=e.width/512;return[3*t,4*t]}(r),a=(r.width+r.height)/36;return c(n("circle"),{stroke:e.color,"stroke-width":s[o?0:1],fill:"none",opacity:p(e,o),cx:i[0],cy:i[1],r:a-s[1]/2})}(s[t.brush],i,r,g)}return h.setAttribute("cgHash",i),h}function a(e){const t=c(n("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return t.appendChild(c(n("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function c(e,t){for(const o in t)e.setAttribute(o,t[o]);return e}function l(e,t){return"white"===t?e:[8-e[0],8-e[1]]}function d(e,t){return{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(e=>e).join("")}}function u(e,t,o){return(e.lineWidth||10)*(t?.85:1)/512*o.width}function p(e,t){return(e.opacity||1)*(t?.9:1)}function f(e,t){return[(e[0]+.5)*t.width/9,(8.5-e[1])*t.height/9]}Object.defineProperty(t,"__esModule",{value:!0}),t.renderSvg=t.createElement=void 0,t.createElement=n,t.renderSvg=function(e,t){const o=e.drawable,n=o.current,i=n&&n.mouseSq?n:void 0,c=new Map,l=e.dom.bounds();for(const r of o.shapes.concat(o.autoShapes).concat(i?[i]:[]))r.dest&&c.set(r.dest,(c.get(r.dest)||0)+1);const u=o.shapes.concat(o.autoShapes).map(e=>({shape:e,current:!1,hash:r(e,c,!1,l)}));i&&u.push({shape:i,current:!0,hash:r(i,c,!0,l)});const p=u.map(e=>e.hash).join(";");if(p===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=p;const f=t.firstChild;!function(e,t,o){const n=new Map;let r;for(const a of t)a.shape.dest&&(r=e.brushes[a.shape.brush],a.shape.modifiers&&(r=d(r,a.shape.modifiers)),n.set(r.key,r));const i=new Set;let s=o.firstChild;for(;s;)i.add(s.getAttribute("cgKey")),s=s.nextSibling;for(const[c,l]of n.entries())i.has(c)||o.appendChild(a(l))}(o,u,f),function(e,t,o,n,r,i){const a=e.dom.bounds(),c=new Map,l=[];for(const s of t)c.set(s.hash,!1);let d,u=i.nextSibling;for(;u;)d=u.getAttribute("cgHash"),c.has(d)?c.set(d,!0):l.push(u),u=u.nextSibling;for(const s of l)r.removeChild(s);for(const p of t)c.get(p.hash)||r.appendChild(s(e,p,o,n,a))}(e,u,o.brushes,c,t,f)}})),g=e((function(e,n){function r(e,t){const n=o.createEl("coords",t);let r;for(const i of e)r=o.createEl("coord"),r.textContent=i,n.appendChild(r);return n}Object.defineProperty(n,"__esModule",{value:!0}),n.renderWrap=void 0,n.renderWrap=function(e,n,i){e.innerHTML="",e.classList.add("cg-wrap");for(const o of t.colors)e.classList.toggle("orientation-"+o,n.orientation===o);e.classList.toggle("manipulable",!n.viewOnly);const s=o.createEl("cg-helper");let a;e.appendChild(s),o.isMiniBoard(e)&&(n.pockets?(a=[o.createEl("cg-pocket"),o.createEl("cg-pocket")],e.insertBefore(a["white"===n.orientation?0:1],s),e.insertBefore(a["white"===n.orientation?1:0],s.nextSibling)):e.classList.add("no-pockets"));const c=o.createEl("cg-container");s.appendChild(c);const l=o.createEl("cg-board");let d,u;if(c.appendChild(l),n.drawable.visible&&!i&&(d=f.createElement("svg"),d.appendChild(f.createElement("defs")),c.appendChild(d)),n.coordinates){const e="black"===n.orientation?" black":"";0===n.notation||1===n.notation?c.appendChild(r(["9","8","7","6","5","4","3","2","1"],"ranks"+e)):3===n.notation?c.appendChild(r(["i","h","g","f","e","d","c","b","a"],"ranks"+e)):c.appendChild(r(["九","八","七","六","五","四","三","二","一"],"ranks"+e)),c.appendChild(r(["9","8","7","6","5","4","3","2","1"],"files"+e))}return n.draggable.showGhost&&!i&&(u=o.createEl("piece","ghost"),o.setVisible(u,!1),c.appendChild(u)),{board:l,container:c,boardSpan:e,ghost:u,svg:d,pockets:a}}})),h=e((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.drop=t.cancelDropMode=t.setDropMode=void 0,t.setDropMode=function(e,t){e.dropmode={active:!0,piece:t},d.cancel(e)},t.cancelDropMode=function(e){e.dropmode={active:!1}},t.drop=function(e,t){if(!e.dropmode.active)return;r.unsetPremove(e),r.unsetPredrop(e);const n=e.dropmode.piece;if(n){e.pieces.set("a0",n);const i=o.eventPosition(t),s=i&&r.getKeyAtDomPos(i,r.whitePov(e),e.dom.bounds());s&&r.dropNewPiece(e,"a0",s)}e.dom.redraw()}})),v=e((function(e,t){function n(e,t,o,n){return e.addEventListener(t,o,n),()=>e.removeEventListener(t,o,n)}function i(e,t,o){return n=>{e.drawable.current?e.drawable.enabled&&o(e,n):e.viewOnly||t(e,n)}}Object.defineProperty(t,"__esModule",{value:!0}),t.bindDocument=t.bindBoard=void 0,t.bindBoard=function(e,t){const n=e.dom.elements.board;if(!e.dom.relative&&e.resizable&&"ResizeObserver"in window){new window.ResizeObserver(t).observe(n)}if(e.viewOnly)return;const i=function(e){return t=>{e.draggable.current?d.cancel(e):e.drawable.current?l.cancel(e):t.shiftKey||o.isRightButton(t)?e.drawable.enabled&&l.start(e,t):e.viewOnly||(e.dropmode.active&&!function(e,t){const n=o.eventPosition(t),i=n&&r.getKeyAtDomPos(n,r.whitePov(e),e.dom.bounds());return!(!i||!e.pieces.has(i))}(e,t)?h.drop(e,t):d.start(e,t))}}(e);n.addEventListener("touchstart",i,{passive:!1}),n.addEventListener("mousedown",i,{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",e=>e.preventDefault())},t.bindDocument=function(e,t){const o=[];if(e.dom.relative||!e.resizable||"ResizeObserver"in window||o.push(n(document.body,"shogiground.resize",t)),!e.viewOnly){const t=i(e,d.move,l.move),r=i(e,d.end,l.end);for(const e of["touchmove","mousemove"])o.push(n(document,e,t));for(const e of["touchend","mouseup"])o.push(n(document,e,r));const s=()=>e.dom.bounds.clear();o.push(n(document,"scroll",s,{capture:!0,passive:!0})),o.push(n(window,"resize",s,{passive:!0}))}return()=>o.forEach(e=>e())}})),m=e((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.updateBounds=t.render=void 0;const n=o;function i(e){return"PIECE"===e.tagName}function a(e){return"SQUARE"===e.tagName}function c(e,t){for(const o of t)e.dom.elements.board.removeChild(o)}function l(e,t){let o=2+9*e[1]+(8-e[0]);return t&&(o=84-o),o+""}function d(e){return`${e.color} ${e.role}`}function u(e,t,o){const n=e.get(t);n?e.set(t,`${n} ${o}`):e.set(t,o)}function p(e,t,o){const n=e.get(t);n?n.push(o):e.set(t,[o])}t.render=function(e){const t=r.whitePov(e),f=e.dom.relative?n.posToTranslateRel:n.posToTranslateAbs(e.dom.bounds()),g=e.dom.relative?n.translateRel:n.translateAbs,h=e.dom.elements.board,v=e.dom.elements.pockets,m=e.pieces,b=e.animation.current,w=b?b.plan.anims:new Map,y=b?b.plan.fadings:new Map,k=e.draggable.current,P=function(e){var t;const o=new Map;if(e.lastMove&&e.highlight.lastMove)for(const r of e.lastMove)r.includes("*")||u(o,r,"last-move");e.check&&e.highlight.check&&u(o,e.check,"check");if(e.selected&&(u(o,e.selected,"selected"),e.movable.showDests)){const n=null===(t=e.movable.dests)||void 0===t?void 0:t.get(e.selected);if(n)for(const t of n)u(o,t,"move-dest"+(e.pieces.has(t)?" oc":""));const r=e.premovable.dests;if(r)for(const t of r)u(o,t,"premove-dest"+(e.pieces.has(t)?" oc":""))}const n=e.premovable.current;if(n)for(const r of n)u(o,r,"current-premove");else e.predroppable.current&&u(o,e.predroppable.current.key,"current-premove");return o}(e),M=new Set,C=new Set,S=new Map,A=new Map;let K,O,E,D,_,L,x,N,j,T;for(O=h.firstChild;O;){if(K=O.cgKey,i(O))if(E=m.get(K),_=w.get(K),L=y.get(K),D=O.cgPiece,O.classList.remove("fix-blur"),"a0"===K&&O.classList.add("fix-blur"),!O.cgDragging||k&&k.orig===K||(O.classList.remove("dragging"),g(O,f(o.key2pos(K),t)),O.cgDragging=!1),!L&&O.cgFading&&(O.cgFading=!1,O.classList.remove("fading")),E){if(_&&O.cgAnimating&&D===d(E)){const e=o.key2pos(K);e[0]+=_[2],e[1]+=_[3],O.classList.add("anim"),g(O,f(e,t))}else O.cgAnimating&&(O.cgAnimating=!1,O.classList.remove("anim"),g(O,f(o.key2pos(K),t)),e.addPieceZIndex&&(O.style.zIndex=l(o.key2pos(K),t)));D!==d(E)||L&&O.cgFading?L&&D===d(L)?(O.classList.add("fading"),O.cgFading=!0):p(S,D,O):M.add(K)}else p(S,D,O);else if(a(O)){const e=O.className;P.get(K)===e?C.add(K):p(A,e,O)}O=O.nextSibling}for(const[n,r]of P)if(!C.has(n)){j=A.get(r),T=j&&j.pop();const e=f(o.key2pos(n),t);if(T)T.cgKey=n,g(T,e);else{const t=o.createEl("square",r);t.cgKey=n,g(t,e),h.insertBefore(t,h.firstChild)}}for(const[n,r]of m)if(_=w.get(n),!M.has(n))if(x=S.get(d(r)),N=x&&x.pop(),N){N.cgKey=n,N.cgFading&&(N.classList.remove("fading"),N.cgFading=!1);const r=o.key2pos(n);e.addPieceZIndex&&(N.style.zIndex=l(r,t)),_&&(N.cgAnimating=!0,N.classList.add("anim"),r[0]+=_[2],r[1]+=_[3]),g(N,f(r,t))}else{const i=d(r),s=o.createEl("piece",i),a=o.key2pos(n);s.cgPiece=i,s.cgKey=n,_&&(s.cgAnimating=!0,a[0]+=_[2],a[1]+=_[3]),g(s,f(a,t)),e.addPieceZIndex&&(s.style.zIndex=l(a,t)),h.appendChild(s)}if(console.log(e.pockets),e.pockets&&v)for(const o of[0,1]){let t;t=v[o].innerHTML?v[o].firstChild:s.addPocketEl(e,v[o],0===o?"white":"black");for(const n of t.getElementsByTagName("piece")){const t=n.getAttribute("data-role");n.setAttribute("data-nb",e.pockets[o][t])}}for(const o of S.values())c(e,o);for(const o of A.values())c(e,o)},t.updateBounds=function(e){if(e.dom.relative)return;const t=r.whitePov(e),s=n.posToTranslateAbs(e.dom.bounds());let c=e.dom.elements.board.firstChild;for(;c;)(i(c)&&!c.cgAnimating||a(c))&&n.translateAbs(c,s(o.key2pos(c.cgKey),t)),c=c.nextSibling}}));return e((function(e,t){function n(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}Object.defineProperty(t,"__esModule",{value:!0}),t.Shogiground=void 0,t.Shogiground=function(e,t){const r=p.defaults();function i(){const t=r.dom&&r.dom.unbind,i=r.viewOnly&&!r.drawable.visible,s=g.renderWrap(e,r,i),a=o.memo(()=>s.board.getBoundingClientRect()),c=e=>{m.render(r),!e&&s.svg&&f.renderSvg(r,s.svg)},l=()=>{a.clear(),m.updateBounds(r),s.svg&&f.renderSvg(r,s.svg)};r.dom={elements:s,bounds:a,redraw:n(c),redrawNow:c,unbind:t,relative:i},r.drawable.prevSvgHash="",c(!1),v.bindBoard(r,l),t||(r.dom.unbind=v.bindDocument(r,l)),r.events.insert&&r.events.insert(s)}return a.configure(r,t||{}),i(),u.start(r,i)}})).Shogiground}();
