var Shogiground=function(){"use strict";function e(e,o,t){return e(t={path:o,exports:{},require:function(e,o){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==o&&t.path)}},t.exports),t.exports}var o=e((function(e,o){Object.defineProperty(o,"__esModule",{value:!0}),o.ranks=o.files=o.colors=void 0,o.colors=["sente","gote"],o.files=["a","b","c","d","e","f","g","h","i"],o.ranks=["1","2","3","4","5","6","7","8","9"]})),t=e((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.droppableRoles=t.isMiniBoard=t.createEl=t.isRightButton=t.eventPosition=t.setVisible=t.translateRel=t.translateAbs=t.posToTranslateRel=t.posToTranslateAbs=t.validProm=t.samePiece=t.distanceSq=t.opposite=t.timer=t.memo=t.key2pos=t.pos2key=t.allKeys=t.invRanks=void 0,t.invRanks=["9","8","7","6","5","4","3","2","1"];const n={rook:"dragon",bishop:"horse",silver:"promotedsilver",knight:"promotedknight",lance:"promotedlance",pawn:"tokin"};t.allKeys=Array.prototype.concat(...o.files.map(e=>o.ranks.map(o=>e+o))),t.pos2key=e=>t.allKeys[9*e[0]+e[1]],t.key2pos=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],t.memo=function(e){let o;const t=()=>(void 0===o&&(o=e()),o);return t.clear=()=>{o=void 0},t},t.timer=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const o=performance.now()-e;return e=void 0,o}}},t.opposite=e=>"sente"===e?"gote":"sente",t.distanceSq=(e,o)=>{const t=e[0]-o[0],n=e[1]-o[1];return t*t+n*n},t.samePiece=(e,o)=>e.role===o.role&&e.color===o.color,t.validProm=(e,o)=>e.color===o.color&&(n[e.role]==o.role||n[o.role]==e.role);const r=(e,o,t,n)=>[(o?e[0]:8-e[0])*t,(o?8-e[1]:e[1])*n];t.posToTranslateAbs=e=>{const o=e.width/9,t=e.height/9;return(e,n)=>r(e,n,o,t)},t.posToTranslateRel=(e,o)=>r(e,o,100,100),t.translateAbs=(e,o)=>{e.style.transform=`translate(${o[0]}px,${o[1]}px)`},t.translateRel=(e,o)=>{e.style.transform=`translate(${o[0]}%,${o[1]}%)`},t.setVisible=(e,o)=>{e.style.visibility=o?"visible":"hidden"},t.eventPosition=e=>e.clientX||0===e.clientX?[e.clientX,e.clientY]:e.touches&&e.targetTouches[0]?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0,t.isRightButton=e=>2===e.buttons||2===e.button,t.createEl=(e,o)=>{const t=document.createElement(e);return o&&(t.className=o),t},t.isMiniBoard=e=>Array.from(e.classList).includes("mini-board"),t.droppableRoles=["pawn","lance","knight","silver","gold","bishop","rook"]})),n=e((function(e,o){function n(e,o){return Math.abs(e-o)}Object.defineProperty(o,"__esModule",{value:!0}),o.predrop=o.premove=void 0;const r=(e,o,t,r)=>n(e,t)===n(o,r),s=(e,o,t,n)=>e===t||o===n,i=(e,o,t,r)=>n(e,t)<2&&n(o,r)<2;const c=(e,o,t,n)=>i(e,o,t,n)||r(e,o,t,n),a=(e,o,t,n)=>i(e,o,t,n)||s(e,o,t,n),l=t.allKeys.map(t.key2pos);o.premove=function(e,o){const d=e.get(o);if(!d)return[];const p=t.key2pos(o),u=d.role,f="pawn"===u?(g=d.color,(e,o,t,n)=>"sente"===g?e===t&&o+1===n:e===t&&o-1===n):"knight"===u?function(e){return(o,t,r,s)=>1===n(o,r)&&2===n(t,s)&&("sente"===e?s>t:s<t)}(d.color):"bishop"===u?r:"rook"===u?s:"king"===u?i:"silver"===u?function(e){return(o,t,r,s)=>n(o,r)<2&&n(t,s)<2&&t!=s&&("sente"===e?o!=r||s>t:o!=r||s<t)}(d.color):"lance"===u?function(e){return(o,t,n,r)=>"sente"===e?o==n&&r>t:o==n&&t>r}(d.color):"horse"===u?c:"dragon"===u?a:function(e){return(o,t,r,s)=>n(o,r)<2&&n(t,s)<2&&("sente"===e?s>=t||o==r:s<=t||o==r)}(d.color);var g;return l.filter(e=>(p[0]!==e[0]||p[1]!==e[1])&&f(p[0],p[1],e[0],e[1])).map(t.pos2key)},o.predrop=function(e,o){const n=o.color,r=o.role;return t.allKeys.filter(o=>{const t=e.get(o);return!(t&&t.color===n||("pawn"===r||"lance"===r?function(e,o){return"sente"===o?"9"===e[1]:"1"===e[1]}(o,n):"knight"===r&&function(e,o){return"sente"===o?"8"===e[1]||"9"===e[1]:"1"===e[1]||"2"===e[1]}(o,n)))})}})),r=e((function(e,o){function r(e,...o){e&&setTimeout(()=>e(...o),1)}function s(e){e.premovable.current&&(e.premovable.current=void 0,r(e.premovable.events.unset))}function i(e){const o=e.predroppable;o.current&&(o.current=void 0,r(o.events.unset))}function c(e,o,n){const s=e.pieces.get(o),i=e.pieces.get(n);if(o===n||!s)return!1;const c=i&&i.color!==s.color?i:void 0;return n===e.selected&&u(e),r(e.events.move,o,n,c),function(e,o,n){if(!e.autoCastle)return!1;const r=e.pieces.get(o);if(!r||"king"!==r.role)return!1;const s=t.key2pos(o),i=t.key2pos(n);if(0!==s[1]&&7!==s[1]||s[1]!==i[1])return!1;4!==s[0]||e.pieces.has(n)||(6===i[0]?n=t.pos2key([7,i[1]]):2===i[0]&&(n=t.pos2key([0,i[1]])));const c=e.pieces.get(n);return!(!c||c.color!==r.color||"rook"!==c.role)&&(e.pieces.delete(o),e.pieces.delete(n),s[0]<i[0]?(e.pieces.set(t.pos2key([6,i[1]]),r),e.pieces.set(t.pos2key([5,i[1]]),c)):(e.pieces.set(t.pos2key([2,i[1]]),r),e.pieces.set(t.pos2key([3,i[1]]),c)),!0)}(e,o,n)||(e.pieces.set(n,s),e.pieces.delete(o)),e.lastMove=[o,n],e.check=void 0,r(e.events.change),c||!0}function a(e,o,n,s){if(e.pieces.has(n)){if(!s)return!1;e.pieces.delete(n)}return r(e.events.dropNewPiece,o,n),e.pieces.set(n,o),e.lastMove=[n],e.check=void 0,r(e.events.change),e.movable.dests=void 0,e.dropmode.dropDests=void 0,e.turnColor=t.opposite(e.turnColor),!0}function l(e,o,n){const r=c(e,o,n);return r&&(e.movable.dests=void 0,e.dropmode.dropDests=void 0,e.turnColor=t.opposite(e.turnColor),e.animation.current=void 0),r}function d(e,o,t){if(g(e,o,t)){const n=l(e,o,t);if(n){const s=e.hold.stop();u(e);const i={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:s};return!0!==n&&(i.captured=n),r(e.movable.events.after,o,t,i),!0}}else if(function(e,o,t){return o!==t&&v(e,o)&&n.premove(e.pieces,o).includes(t)}(e,o,t))return function(e,o,t,n){i(e),e.premovable.current=[o,t],r(e.premovable.events.set,o,t,n)}(e,o,t,{ctrlKey:e.stats.ctrlKey}),u(e),!0;return u(e),!1}function p(e,o){e.selected=o,v(e,o)?e.premovable.dests=n.premove(e.pieces,o):(e.premovable.dests=void 0,e.predroppable.dropDests=void 0)}function u(e){e.selected=void 0,e.premovable.dests=void 0,e.predroppable.dropDests=void 0,e.hold.cancel()}function f(e,o){const t=e.pieces.get(o);return!!t&&("both"===e.movable.color||e.movable.color===t.color&&e.turnColor===t.color)}function g(e,o,t){var n,r;return o!==t&&f(e,o)&&(e.movable.free||!!(null===(r=null===(n=e.movable.dests)||void 0===n?void 0:n.get(o))||void 0===r?void 0:r.includes(t)))}function v(e,o){const t=e.pieces.get(o);return!!t&&e.premovable.enabled&&e.movable.color===t.color&&e.turnColor!==t.color}function m(e){s(e),i(e),u(e)}Object.defineProperty(o,"__esModule",{value:!0}),o.sentePov=o.getKeyAtDomPos=o.stop=o.cancelMove=o.playPredrop=o.playPremove=o.isDraggable=o.isPredroppable=o.canMove=o.unselect=o.setSelected=o.selectSquare=o.dropNewPiece=o.userMove=o.baseNewPiece=o.baseMove=o.unsetPredrop=o.unsetPremove=o.setCheck=o.setPieces=o.reset=o.toggleOrientation=o.callUserFunction=void 0,o.callUserFunction=r,o.toggleOrientation=function(e){e.orientation=t.opposite(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0},o.reset=function(e){e.lastMove=void 0,u(e),s(e),i(e)},o.setPieces=function(e,o){for(const[t,n]of o)n?e.pieces.set(t,n):e.pieces.delete(t)},o.setCheck=function(e,o){if(e.check=void 0,!0===o&&(o=e.turnColor),o)for(const[t,n]of e.pieces)"king"===n.role&&n.color===o&&(e.check=t)},o.unsetPremove=s,o.unsetPredrop=i,o.baseMove=c,o.baseNewPiece=a,o.userMove=d,o.dropNewPiece=function(e,o,t,n){const c=e.pieces.get(o);c&&(function(e,o,t){const n=e.pieces.get(o);return!(!n||o!==t&&e.pieces.has(t)||"both"!==e.movable.color&&(e.movable.color!==n.color||e.turnColor!==n.color))}(e,o,t)||n)?(e.pieces.delete(o),a(e,c,t,n),r(e.movable.events.afterNewPiece,c.role,t,{predrop:!1})):c&&function(e,o,t){const n=e.pieces.get(o),r=e.pieces.get(t);return!!n&&(!r||r.color!==e.movable.color)&&e.predroppable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}(e,o,t)?function(e,o,t){s(e),e.predroppable.current={role:o,key:t},r(e.predroppable.events.set,o,t)}(e,c.role,t):(s(e),i(e)),e.pieces.delete(o),u(e)},o.selectSquare=function(e,o,t){if(r(e.events.select,o),e.selected){if(e.selected===o&&!e.draggable.enabled)return u(e),void e.hold.cancel();if((e.selectable.enabled||t)&&e.selected!==o&&d(e,e.selected,o))return void(e.stats.dragged=!1)}(f(e,o)||v(e,o))&&(p(e,o),e.hold.start())},o.setSelected=p,o.unselect=u,o.canMove=g,o.isPredroppable=function(e){var o,t;const n=e.dropmode.active?e.dropmode.piece:null===(o=e.draggable.current)||void 0===o?void 0:o.piece;return!!n&&(e.dropmode.active||"a0"===(null===(t=e.draggable.current)||void 0===t?void 0:t.orig))&&e.predroppable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color},o.isDraggable=function(e,o){const t=e.pieces.get(o);return!!t&&e.draggable.enabled&&("both"===e.movable.color||e.movable.color===t.color&&(e.turnColor===t.color||e.premovable.enabled))},o.playPremove=function(e){const o=e.premovable.current;if(!o)return!1;const t=o[0],n=o[1];let i=!1;if(g(e,t,n)){const o=l(e,t,n);if(o){const s={premove:!0};!0!==o&&(s.captured=o),r(e.movable.events.after,t,n,s),i=!0}}return s(e),i},o.playPredrop=function(e,o){const t=e.predroppable.current;let n=!1;if(!t)return!1;if(o(t)){a(e,{role:t.role,color:e.movable.color},t.key)&&(r(e.movable.events.afterNewPiece,t.role,t.key,{predrop:!0}),n=!0)}return i(e),n},o.cancelMove=m,o.stop=function(e){e.movable.color=e.movable.dests=e.dropmode.dropDests=e.animation.current=void 0,m(e)},o.getKeyAtDomPos=function(e,o,n){let r=Math.floor(9*(e[0]-n.left)/n.width);o||(r=8-r);let s=8-Math.floor(9*(e[1]-n.top)/n.height);return o||(s=8-s),r>=0&&r<9&&s>=0&&s<9?t.pos2key([r,s]):void 0},o.sentePov=function(e){return"sente"===e.orientation}})),s=e((function(e,n){Object.defineProperty(n,"__esModule",{value:!0}),n.write=n.read=n.initial=void 0,n.initial="lnsgkgsnl/1r5b1/ppppppppp/9/9/9/PPPPPPPPP/1B5R1/LNSGKGSNL";const r={p:"pawn",l:"lance",n:"knight",s:"silver",g:"gold",b:"bishop",r:"rook",k:"king","+p":"tokin",t:"tokin","+l":"promotedlance",u:"promotedlance","+n":"promotedknight",m:"promotedknight","+s":"promotedsilver",a:"promotedsilver","+b":"horse",h:"horse","+r":"dragon",d:"dragon"},s={pawn:"p",lance:"l",knight:"n",silver:"s",gold:"g",bishop:"b",rook:"r",king:"k",tokin:"+p",promotedlance:"+l",promotedknight:"+n",promotedsilver:"+s",horse:"+b",dragon:"+r"};n.read=function(e){"start"===e&&(e=n.initial);const o=new Map;let s=8,i=0;for(let n=0;n<e.length;n++)switch(e[n]){case" ":case"_":return o;case"/":if(--s,s<0)return o;i=0;break;default:const c=e[n].charCodeAt(0);if(c<58&&43!=c)i+=c-48;else{const c="+"===e[n]&&e.length>n+1?"+"+e[++n].toLowerCase():e[n].toLowerCase(),a=e[n]===c||"+"+e[n]===c?"gote":"sente";o.set(t.pos2key([i,s]),{role:r[c],color:a}),++i}}return o},n.write=function(e){return t.invRanks.map(t=>o.files.map(o=>{const n=e.get(o+t);if(n){const e=s[n.role];return"sente"===n.color?e.toUpperCase():e}return"1"}).join("")).join("/").replace(/1{2,}/g,e=>e.length.toString())}})),i=e((function(e,o){Object.defineProperty(o,"__esModule",{value:!0}),o.addPocketEl=o.makePockets=void 0;const n={p:"pawn",l:"lance",n:"knight",s:"silver",g:"gold",b:"bishop",r:"rook"};o.makePockets=function(e){const o=[{pawn:0,lance:0,knight:0,silver:0,gold:0,bishop:0,rook:0},{pawn:0,lance:0,knight:0,silver:0,gold:0,bishop:0,rook:0}];if(!e)return o;try{let n=JSON.parse(e);for(const e of[0,1])for(const r of t.droppableRoles)o[e][r]=n[e][r]||0}catch(r){let t=0;for(const s of e){const e=n[s.toLowerCase()];e?(o[s.toLowerCase()===s?1:0][e]+=t||1,t=0):t=10*t+Number(s)}}return o},o.addPocketEl=function(e,o,n){const r="sente"===e.orientation!=("sente"==n)?"top":"bottom",s=t.createEl("div","pocket is2d pocket-"+r);o.appendChild(s);for(const i of t.droppableRoles){const e=t.createEl("div","pocket-c1");s.appendChild(e);const o=t.createEl("div","pocket-c2");e.appendChild(o);const r=t.createEl("piece",i+" "+n);r.setAttribute("data-role",i),r.setAttribute("data-color",n),r.setAttribute("data-nb","0"),o.appendChild(r)}return s}})),c=e((function(e,o){function t(e){return"object"==typeof e}Object.defineProperty(o,"__esModule",{value:!0}),o.configure=void 0,o.configure=function(e,o){var n,c;if((null===(n=o.movable)||void 0===n?void 0:n.dests)&&(e.movable.dests=void 0),(null===(c=o.dropmode)||void 0===c?void 0:c.dropDests)&&(e.dropmode.dropDests=void 0),function e(o,n){for(const r in n)t(o[r])&&t(n[r])?e(o[r],n[r]):o[r]=n[r]}(e,o),o.fen&&(e.pieces=s.read(o.fen),e.drawable.shapes=[]),o.hasPockets&&(e.pockets=i.makePockets(o.pockets)),o.hasOwnProperty("check")&&r.setCheck(e,o.check||!1),o.hasOwnProperty("lastMove")&&!o.lastMove?e.lastMove=void 0:o.lastMove&&(e.lastMove=o.lastMove),e.selected&&r.setSelected(e,e.selected),(!e.animation.duration||e.animation.duration<100)&&(e.animation.enabled=!1),!e.movable.rookCastle&&e.movable.dests){const o="sente"===e.movable.color?"1":"9",t="e"+o,n=e.movable.dests.get(t),r=e.pieces.get(t);if(!n||!r||"king"!==r.role)return;e.movable.dests.set(t,n.filter(e=>!(e==="a"+o&&n.includes("c"+o)||e==="h"+o&&n.includes("g"+o))))}}})),a=e((function(e,o){function n(e,o){const t=e(o);return o.dom.redraw(),t}function r(e,o){return{key:e,pos:t.key2pos(e),piece:o}}function s(e,o){return o.sort((o,n)=>t.distanceSq(e.pos,o.pos)-t.distanceSq(e.pos,n.pos))[0]}Object.defineProperty(o,"__esModule",{value:!0}),o.render=o.anim=void 0,o.anim=function(e,o){return o.animation.enabled?function(e,o){const n=new Map(o.pieces),i=e(o),c=function(e,o){const n=new Map,i=[],c=new Map,a=[],l=[],d=new Map;let p,u,f;for(const[t,s]of e)d.set(t,r(t,s));for(const s of t.allKeys)p=o.pieces.get(s),u=d.get(s),p?u?t.samePiece(p,u.piece)||(a.push(u),l.push(r(s,p))):l.push(r(s,p)):u&&a.push(u);for(const r of l)u=s(r,a.filter(e=>t.samePiece(r.piece,e.piece))),u&&(f=[u.pos[0]-r.pos[0],u.pos[1]-r.pos[1]],n.set(r.key,f.concat(f)),i.push(u.key));for(const t of a)i.includes(t.key)||c.set(t.key,t.piece);return{anims:n,fadings:c}}(n,o);if(c.anims.size||c.fadings.size){const e=o.animation.current&&o.animation.current.start;o.animation.current={start:performance.now(),frequency:1/o.animation.duration,plan:c},e||function e(o,t){const n=o.animation.current;if(void 0===n)return void(o.dom.destroyed||o.dom.redrawNow());const r=1-(t-n.start)*n.frequency;if(r<=0)o.animation.current=void 0,o.dom.redrawNow();else{const t=(s=r)<.5?4*s*s*s:(s-1)*(2*s-2)*(2*s-2)+1;for(const e of n.plan.anims.values())e[2]=e[0]*t,e[3]=e[1]*t;o.dom.redrawNow(!0),requestAnimationFrame((t=performance.now())=>e(o,t))}var s}(o,performance.now())}else o.dom.redraw();return i}(e,o):n(e,o)},o.render=n})),l=e((function(e,o){Object.defineProperty(o,"__esModule",{value:!0}),o.clear=o.cancel=o.end=o.move=o.processDraw=o.start=void 0;const n=["green","red","blue","yellow"];function s(e){requestAnimationFrame(()=>{const o=e.drawable.current;if(o){const t=r.getKeyAtDomPos(o.pos,r.sentePov(e),e.dom.bounds());t!==o.mouseSq&&(o.mouseSq=t,o.dest=t!==o.orig?t:void 0,o.piece=o.dest?void 0:e.drawable.piece,e.dom.redrawNow()),s(e)}})}function i(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function c(e){const o=(e.shiftKey||e.ctrlKey)&&t.isRightButton(e),r=e.altKey||e.metaKey||e.getModifierState("AltGraph");return n[(o?1:0)+(r?2:0)]}function a(e){e.onChange&&e.onChange(e.shapes)}o.start=function(e,o){if(o.touches&&o.touches.length>1)return;o.stopPropagation(),o.preventDefault(),o.ctrlKey?r.unselect(e):r.cancelMove(e);const n=t.eventPosition(o),i=r.getKeyAtDomPos(n,r.sentePov(e),e.dom.bounds()),a=e.drawable.piece;i&&(e.drawable.current={orig:i,pos:n,piece:a,brush:c(o)},s(e))},o.processDraw=s,o.move=function(e,o){e.drawable.current&&(e.drawable.current.pos=t.eventPosition(o))},o.end=function(e){const o=e.drawable.current;o&&(o.mouseSq&&function(e,o){const t=e=>e.orig===o.orig&&e.dest===o.dest,n=e.shapes.find(t),r=e.shapes.find(e=>e.orig===o.orig&&e.piece&&o.piece&&(e.piece.color!==o.piece.color||e.piece.role!==o.piece.role));n&&(e.shapes=e.shapes.filter(e=>!t(e)));n&&n.brush===o.brush&&!r||e.shapes.push(o);!o.piece||n&&n.brush===o.brush&&!r||e.shapes.push({orig:o.orig,brush:o.brush});a(e)}(e.drawable,o),i(e))},o.cancel=i,o.clear=function(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),a(e.drawable))}})),d=e((function(e,o){function s(e){requestAnimationFrame(()=>{var o;const n=e.draggable.current;if(!n)return;(null===(o=e.animation.current)||void 0===o?void 0:o.plan.anims.has(n.orig))&&(e.animation.current=void 0);const r=e.pieces.get(n.orig);if(r&&t.samePiece(r,n.piece)){if(!n.started&&t.distanceSq(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0),n.started){if("function"==typeof n.element){const e=n.element();if(!e)return;e.cgDragging=!0,e.classList.add("dragging"),e.classList.remove("fix-blur"),n.element=e}const o=e.dom.bounds();t.translateAbs(n.element,[n.pos[0]-o.left-o.width/18,n.pos[1]-o.top-o.height/18])}}else i(e);s(e)})}function i(e){const o=e.draggable.current;o&&(o.newPiece&&e.pieces.delete(o.orig),e.draggable.current=void 0,r.unselect(e),c(e),e.dom.redraw())}function c(e){const o=e.dom.elements;o.ghost&&t.setVisible(o.ghost,!1)}function d(e,o,n){const r=t.key2pos(e);return o||(r[0]=8-r[0],r[1]=8-r[1]),[n.left+n.width*r[0]/9+n.width/18,n.top+n.height*(8-r[1])/9+n.height/18]}function p(e,o){let t=e.dom.elements.board.firstChild;for(;t;){if(t.cgKey===o&&"PIECE"===t.tagName)return t;t=t.nextSibling}}Object.defineProperty(o,"__esModule",{value:!0}),o.cancel=o.end=o.move=o.dragNewPiece=o.start=void 0,o.start=function(e,o){if(void 0!==o.button&&0!==o.button)return;if(o.touches&&o.touches.length>1)return;const n=e.dom.bounds(),i=t.eventPosition(o),c=r.getKeyAtDomPos(i,r.sentePov(e),n);if(!c)return;const u=e.pieces.get(c),f=e.selected;f||!e.drawable.enabled||!e.drawable.eraseOnClick&&u&&u.color===e.turnColor||l.clear(e),!1===o.cancelable||o.touches&&e.movable.color&&!u&&!f&&!function(e,o){const n=r.sentePov(e),s=e.dom.bounds(),i=Math.pow(s.width/9,2);for(const r in e.pieces){const e=d(r,n,s);if(t.distanceSq(e,o)<=i)return!0}return!1}(e,i)||o.preventDefault();const g=!!e.premovable.current,v=!!e.predroppable.current||!!e.predroppable.dropDests;e.stats.ctrlKey=o.ctrlKey,e.selected&&r.canMove(e,e.selected,c)?a.anim(e=>r.selectSquare(e,c),e):r.selectSquare(e,c);const m=e.selected===c,b=p(e,c);if(u&&b&&m&&r.isDraggable(e,c)){e.draggable.current={orig:c,piece:u,origPos:i,pos:i,started:e.draggable.autoDistance&&e.stats.dragged,element:b,previouslySelected:f,originTarget:o.target},b.cgDragging=!0,b.classList.add("dragging"),b.classList.remove("fix-blur");const a=e.dom.elements.ghost;a&&(a.className=`ghost ${u.color} ${u.role}`,t.translateAbs(a,t.posToTranslateAbs(n)(t.key2pos(c),r.sentePov(e))),t.setVisible(a,!0)),s(e)}else g&&r.unsetPremove(e),v&&r.unsetPredrop(e);e.dom.redraw()},o.dragNewPiece=function(e,o,i,c){e.pieces.set("a0",o),r.unselect(e),e.dom.redraw();const a=t.eventPosition(i);e.draggable.current={orig:"a0",piece:o,origPos:a,pos:a,started:!0,element:()=>p(e,"a0"),originTarget:i.target,newPiece:!0,force:!!c},o&&r.isPredroppable(e)&&(e.predroppable.dropDests=n.predrop(e.pieces,o)),s(e)},o.move=function(e,o){e.draggable.current&&(!o.touches||o.touches.length<2)&&(e.draggable.current.pos=t.eventPosition(o))},o.end=function(e,o){const n=e.draggable.current;if(!n)return;if("touchend"===o.type&&!1!==o.cancelable&&o.preventDefault(),"touchend"===o.type&&n.originTarget!==o.target&&!n.newPiece)return void(e.draggable.current=void 0);r.unsetPremove(e),r.unsetPredrop(e);const s=t.eventPosition(o)||n.pos,i=r.getKeyAtDomPos(s,r.sentePov(e),e.dom.bounds());i&&n.started&&n.orig!==i?n.newPiece?r.dropNewPiece(e,n.orig,i,n.force):(e.stats.ctrlKey=o.ctrlKey,r.userMove(e,n.orig,i)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!i&&(e.pieces.delete(n.orig),r.callUserFunction(e.events.change)),(n.orig!==n.previouslySelected||n.orig!==i&&i)&&e.selectable.enabled||r.unselect(e),c(e),e.draggable.current=void 0,e.dom.redraw()},o.cancel=i})),p=e((function(e,o){Object.defineProperty(o,"__esModule",{value:!0}),o.start=void 0,o.start=function(e,o){function t(){r.toggleOrientation(e),o()}return{set(o){o.orientation&&o.orientation!==e.orientation&&t(),(o.fen?a.anim:a.render)(e=>c.configure(e,o),e)},state:e,getFen:()=>s.write(e.pieces),toggleOrientation:t,setPieces(o){a.anim(e=>r.setPieces(e,o),e)},selectSquare(o,t){o?a.anim(e=>r.selectSquare(e,o,t),e):e.selected&&(r.unselect(e),e.dom.redraw())},move(o,t){a.anim(e=>r.baseMove(e,o,t),e)},newPiece(o,t){a.anim(e=>r.baseNewPiece(e,o,t),e)},playPremove(){if(e.premovable.current){if(a.anim(r.playPremove,e))return!0;e.dom.redraw()}return!1},playPredrop(o){if(e.predroppable.current){const t=r.playPredrop(e,o);return e.dom.redraw(),t}return!1},cancelPremove(){a.render(r.unsetPremove,e)},cancelPredrop(){a.render(r.unsetPredrop,e)},cancelMove(){a.render(e=>{r.cancelMove(e),d.cancel(e)},e)},stop(){a.render(e=>{r.stop(e),d.cancel(e)},e)},setAutoShapes(o){a.render(e=>e.drawable.autoShapes=o,e)},setShapes(o){a.render(e=>e.drawable.shapes=o,e)},getKeyAtDomPos:o=>r.getKeyAtDomPos(o,r.sentePov(e),e.dom.bounds()),redrawAll:o,dragNewPiece(o,t,n){d.dragNewPiece(e,o,t,n)},destroy(){r.stop(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}})),u=e((function(e,o){Object.defineProperty(o,"__esModule",{value:!0}),o.defaults=void 0,o.defaults=function(){return{pieces:s.read(s.initial),orientation:"sente",turnColor:"sente",coordinates:!0,autoCastle:!0,viewOnly:!1,disableContextMenu:!1,resizable:!0,addPieceZIndex:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!0,showDropDests:!0,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1,showDropDests:!0},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},pieces:{baseUrl:"https://lishogi1.org/assets/piece/cburnett/"},prevSvgHash:""},hold:t.timer()}}})),f=e((function(e,o){function n(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function r({orig:e,dest:o,brush:t,piece:n,modifiers:r},i,c,a){return[a.width,a.height,c,e,o,t,o&&(i.get(o)||0)>1,n&&s(n),r&&(l=r,""+(l.lineWidth||""))].filter(e=>e).join(",");var l}function s(e){return[e.color,e.role,e.scale].filter(e=>e).join(",")}function i(e,{shape:o,current:r,hash:s},i,c,g){let v;if(o.piece&&!o.dest)v=function(e,o,r){const s=f(e,r),i=r.width/9*(o.scale||.8);let c=a(n("foreignObject"),{className:`${o.role} ${o.color}`,x:s[0]-i/2,y:s[1]-i/2,width:i,height:i}),l=t.createEl("piece",`${o.color} ${o.role}`);return l.style.width="100%",l.style.height="100%",c.append(l),c}(l(t.key2pos(o.orig),e.orientation),o.piece,g);else{const s=l(t.key2pos(o.orig),e.orientation);if(o.dest){let m=i[o.brush];o.modifiers&&(m=d(m,o.modifiers)),v=function(e,o,t,r,s,i){const c=function(e,o){return(o?20:10)/512*e.width}(i,s&&!r),l=f(o,i),d=f(t,i),g=d[0]-l[0],v=d[1]-l[1],m=Math.atan2(v,g),b=Math.cos(m)*c,h=Math.sin(m)*c;return a(n("line"),{stroke:e.color,"stroke-width":p(e,r,i),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:u(e,r),x1:l[0],y1:l[1],x2:d[0]-b,y2:d[1]-h})}(m,s,l(t.key2pos(o.dest),e.orientation),r,(c.get(o.dest)||0)>1,g)}else v=function(e,o,t,r){const s=f(o,r),i=function(e){const o=e.width/512;return[3*o,4*o]}(r),c=(r.width+r.height)/36;return a(n("circle"),{stroke:e.color,"stroke-width":i[t?0:1],fill:"none",opacity:u(e,t),cx:s[0],cy:s[1],r:c-i[1]/2})}(i[o.brush],s,r,g)}return v.setAttribute("cgHash",s),v}function c(e){const o=a(n("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return o.appendChild(a(n("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),o.setAttribute("cgKey",e.key),o}function a(e,o){for(const t in o)e.setAttribute(t,o[t]);return e}function l(e,o){return"sente"===o?e:[8-e[0],8-e[1]]}function d(e,o){return{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(o.lineWidth||e.lineWidth),key:[e.key,o.lineWidth].filter(e=>e).join("")}}function p(e,o,t){return(e.lineWidth||10)*(o?.85:1)/512*t.width}function u(e,o){return(e.opacity||1)*(o?.9:1)}function f(e,o){return[(e[0]+.5)*o.width/9,(8.5-e[1])*o.height/9]}Object.defineProperty(o,"__esModule",{value:!0}),o.renderSvg=o.createElement=void 0,o.createElement=n,o.renderSvg=function(e,o){const t=e.drawable,n=t.current,s=n&&n.mouseSq?n:void 0,a=new Map,l=e.dom.bounds();for(const r of t.shapes.concat(t.autoShapes).concat(s?[s]:[]))r.dest&&a.set(r.dest,(a.get(r.dest)||0)+1);const p=t.shapes.concat(t.autoShapes).map(e=>({shape:e,current:!1,hash:r(e,a,!1,l)}));s&&p.push({shape:s,current:!0,hash:r(s,a,!0,l)});const u=p.map(e=>e.hash).join(";");if(u===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=u;const f=o.firstChild;!function(e,o,t){const n=new Map;let r;for(const c of o)c.shape.dest&&(r=e.brushes[c.shape.brush],c.shape.modifiers&&(r=d(r,c.shape.modifiers)),n.set(r.key,r));const s=new Set;let i=t.firstChild;for(;i;)s.add(i.getAttribute("cgKey")),i=i.nextSibling;for(const[a,l]of n.entries())s.has(a)||t.appendChild(c(l))}(t,p,f),function(e,o,t,n,r,s){const c=e.dom.bounds(),a=new Map,l=[];for(const i of o)a.set(i.hash,!1);let d,p=s.nextSibling;for(;p;)d=p.getAttribute("cgHash"),a.has(d)?a.set(d,!0):l.push(p),p=p.nextSibling;for(const i of l)r.removeChild(i);for(const u of o)a.get(u.hash)||r.appendChild(i(e,u,t,n,c))}(e,p,t.brushes,a,o,f)}})),g=e((function(e,n){function r(e,o){const n=t.createEl("coords",o);let r;for(const s of e)r=t.createEl("coord"),r.textContent=s,n.appendChild(r);return n}Object.defineProperty(n,"__esModule",{value:!0}),n.renderWrap=void 0,n.renderWrap=function(e,n,s){e.innerHTML="",e.classList.add("cg-wrap");for(const t of o.colors)e.classList.toggle("orientation-"+t,n.orientation===t);e.classList.toggle("manipulable",!n.viewOnly);const i=t.createEl("cg-helper");e.appendChild(i);const c=t.createEl("cg-container");let a;i.appendChild(c),t.isMiniBoard(e)?n.pockets?(a=[t.createEl("cg-pocket"),t.createEl("cg-pocket")],i.insertBefore(a["sente"===n.orientation?1:0],c),i.insertBefore(a["sente"===n.orientation?0:1],c.nextSibling)):e.classList.add("no-pockets"):delete n.pockets;const l=t.createEl("cg-board");let d,p;if(c.appendChild(l),n.drawable.visible&&!s&&(d=f.createElement("svg"),d.appendChild(f.createElement("defs")),c.appendChild(d)),n.coordinates){const e="gote"===n.orientation?" gote":"";0===n.notation||1===n.notation?c.appendChild(r(["9","8","7","6","5","4","3","2","1"],"ranks"+e)):3===n.notation?c.appendChild(r(["i","h","g","f","e","d","c","b","a"],"ranks"+e)):c.appendChild(r(["九","八","七","六","五","四","三","二","一"],"ranks"+e)),c.appendChild(r(["9","8","7","6","5","4","3","2","1"],"files"+e))}return n.draggable.showGhost&&!s&&(p=t.createEl("piece","ghost"),t.setVisible(p,!1),c.appendChild(p)),{board:l,container:c,boardSpan:e,ghost:p,svg:d,pockets:a}}})),v=e((function(e,o){Object.defineProperty(o,"__esModule",{value:!0}),o.drop=o.cancelDropMode=o.setDropMode=void 0,o.setDropMode=function(e,o){e.dropmode.active=!0,e.dropmode.piece=o,d.cancel(e),r.unselect(e),o&&r.isPredroppable(e)&&(e.predroppable.dropDests=n.predrop(e.pieces,o))},o.cancelDropMode=function(e){e.dropmode.active=!1,e.dropmode.piece=void 0},o.drop=function(e,o){if(!e.dropmode.active)return;r.unsetPremove(e),r.unsetPredrop(e);const n=e.dropmode.piece;if(n){e.pieces.set("a0",n);const s=t.eventPosition(o),i=s&&r.getKeyAtDomPos(s,r.sentePov(e),e.dom.bounds());i&&r.dropNewPiece(e,"a0",i)}e.dom.redraw()}})),m=e((function(e,o){function n(e,o,t,n){return e.addEventListener(o,t,n),()=>e.removeEventListener(o,t,n)}function s(e,o,t){return n=>{e.drawable.current?e.drawable.enabled&&t(e,n):e.viewOnly||o(e,n)}}Object.defineProperty(o,"__esModule",{value:!0}),o.bindDocument=o.bindBoard=void 0,o.bindBoard=function(e,o){const n=e.dom.elements.board;if(!e.dom.relative&&e.resizable&&"ResizeObserver"in window){new window.ResizeObserver(o).observe(n)}if(e.viewOnly)return;const s=function(e){return o=>{e.draggable.current?d.cancel(e):e.drawable.current?l.cancel(e):o.shiftKey||t.isRightButton(o)?e.drawable.enabled&&l.start(e,o):e.viewOnly||(e.dropmode.active&&!function(e,o){const n=t.eventPosition(o),s=n&&r.getKeyAtDomPos(n,r.sentePov(e),e.dom.bounds());return!(!s||!e.pieces.has(s))}(e,o)?v.drop(e,o):(v.cancelDropMode(e),d.start(e,o)))}}(e);n.addEventListener("touchstart",s,{passive:!1}),n.addEventListener("mousedown",s,{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",e=>e.preventDefault())},o.bindDocument=function(e,o){const t=[];if(e.dom.relative||!e.resizable||"ResizeObserver"in window||t.push(n(document.body,"shogiground.resize",o)),!e.viewOnly){const o=s(e,d.move,l.move),r=s(e,d.end,l.end);for(const e of["touchmove","mousemove"])t.push(n(document,e,o));for(const e of["touchend","mouseup"])t.push(n(document,e,r));const i=()=>e.dom.bounds.clear();t.push(n(document,"scroll",i,{capture:!0,passive:!0})),t.push(n(window,"resize",i,{passive:!0}))}return()=>t.forEach(e=>e())}})),b=e((function(e,o){Object.defineProperty(o,"__esModule",{value:!0}),o.updateBounds=o.render=void 0;const n=t;function s(e){return"PIECE"===e.tagName}function c(e){return"SQUARE"===e.tagName}function a(e,o){for(const t of o)e.dom.elements.board.removeChild(t)}function l(e,o){let t=2+9*e[1]+(8-e[0]);return o&&(t=84-t),t+""}function d(e){return`${e.color} ${e.role}`}function p(e,o,t){const n=e.get(o);n?e.set(o,`${n} ${t}`):e.set(o,t)}function u(e,o,t){const n=e.get(o);n?n.push(t):e.set(o,[t])}o.render=function(e){const o=r.sentePov(e),f=e.dom.relative?n.posToTranslateRel:n.posToTranslateAbs(e.dom.bounds()),g=e.dom.relative?n.translateRel:n.translateAbs,v=e.dom.elements.board,m=e.dom.elements.pockets,b=e.pieces,h=e.animation.current,y=h?h.plan.anims:new Map,w=h?h.plan.fadings:new Map,k=e.draggable.current,P=function(e){var o,t,n,r;const s=new Map;if(e.lastMove&&e.highlight.lastMove)for(const c of e.lastMove)c.includes("*")||p(s,c,"last-move");e.check&&e.highlight.check&&p(s,e.check,"check");if(e.selected){if(p(s,e.selected,"selected"),e.movable.showDests){const t=null===(o=e.movable.dests)||void 0===o?void 0:o.get(e.selected);if(t)for(const o of t)p(s,o,"move-dest"+(e.pieces.has(o)?" oc":""));const n=e.premovable.dests;if(n)for(const o of n)p(s,o,"premove-dest"+(e.pieces.has(o)?" oc":""))}}else if(e.dropmode.active||"a0"===(null===(t=e.draggable.current)||void 0===t?void 0:t.orig)){const o=e.dropmode.active?e.dropmode.piece:null===(n=e.draggable.current)||void 0===n?void 0:n.piece;if(o&&e.dropmode.showDropDests){const t=null===(r=e.dropmode.dropDests)||void 0===r?void 0:r.get(o.role);if(t)for(const e of t)p(s,e,"move-dest");const n=e.predroppable.dropDests;if(n&&!t)for(const o of n)p(s,o,"premove-dest"+(e.pieces.has(o)?" oc":""))}}const i=e.premovable.current;if(i)for(const c of i)p(s,c,"current-premove");else e.predroppable.current&&p(s,e.predroppable.current.key,"current-premove");return s}(e),M=new Set,C=new Set,D=new Map,S=new Map;let A,O,K,E,_,N,x,L,j,T;for(O=v.firstChild;O;){if(A=O.cgKey,s(O))if(K=b.get(A),_=y.get(A),N=w.get(A),E=O.cgPiece,O.classList.remove("fix-blur"),"a0"===A&&O.classList.add("fix-blur"),!O.cgDragging||k&&k.orig===A||(O.classList.remove("dragging"),g(O,f(t.key2pos(A),o)),O.cgDragging=!1),!N&&O.cgFading&&(O.cgFading=!1,O.classList.remove("fading")),K){if(_&&O.cgAnimating&&E===d(K)){const e=t.key2pos(A);e[0]+=_[2],e[1]+=_[3],O.classList.add("anim"),g(O,f(e,o))}else O.cgAnimating&&(O.cgAnimating=!1,O.classList.remove("anim"),g(O,f(t.key2pos(A),o)),e.addPieceZIndex&&(O.style.zIndex=l(t.key2pos(A),o)));E!==d(K)||N&&O.cgFading?N&&E===d(N)?(O.classList.add("fading"),O.cgFading=!0):u(D,E,O):M.add(A)}else u(D,E,O);else if(c(O)){const e=O.className;P.get(A)===e?C.add(A):u(S,e,O)}O=O.nextSibling}for(const[n,r]of P)if(!C.has(n)){j=S.get(r),T=j&&j.pop();const e=f(t.key2pos(n),o);if(T)T.cgKey=n,g(T,e);else{const o=t.createEl("square",r);o.cgKey=n,g(o,e),v.insertBefore(o,v.firstChild)}}for(const[n,r]of b)if(_=y.get(n),!M.has(n))if(x=D.get(d(r)),L=x&&x.pop(),L){L.cgKey=n,L.cgFading&&(L.classList.remove("fading"),L.cgFading=!1);const r=t.key2pos(n);e.addPieceZIndex&&(L.style.zIndex=l(r,o)),_&&(L.cgAnimating=!0,L.classList.add("anim"),r[0]+=_[2],r[1]+=_[3]),g(L,f(r,o))}else{const s=d(r),i=t.createEl("piece",s),c=t.key2pos(n);i.cgPiece=s,i.cgKey=n,_&&(i.cgAnimating=!0,c[0]+=_[2],c[1]+=_[3]),g(i,f(c,o)),e.addPieceZIndex&&(i.style.zIndex=l(c,o)),v.appendChild(i)}if(e.pockets&&m)for(const t of[0,1]){const o=(m[t].firstElementChild||i.addPocketEl(e,m[t],0===t?"sente":"gote")).getElementsByTagName("piece");for(let n=0;n<o.length;n++){const r=o[n].getAttribute("data-role");o[n].setAttribute("data-nb",e.pockets[t][r||""])}}for(const t of D.values())a(e,t);for(const t of S.values())a(e,t)},o.updateBounds=function(e){if(e.dom.relative)return;const o=r.sentePov(e),i=n.posToTranslateAbs(e.dom.bounds());let a=e.dom.elements.board.firstChild;for(;a;)(s(a)&&!a.cgAnimating||c(a))&&n.translateAbs(a,i(t.key2pos(a.cgKey),o)),a=a.nextSibling}}));return e((function(e,o){function n(e){let o=!1;return()=>{o||(o=!0,requestAnimationFrame(()=>{e(),o=!1}))}}Object.defineProperty(o,"__esModule",{value:!0}),o.Shogiground=void 0,o.Shogiground=function(e,o){const r=u.defaults();function s(){const o=r.dom&&r.dom.unbind,s=r.viewOnly&&!r.drawable.visible,i=g.renderWrap(e,r,s),c=t.memo(()=>i.board.getBoundingClientRect()),a=e=>{b.render(r),!e&&i.svg&&f.renderSvg(r,i.svg)},l=()=>{c.clear(),b.updateBounds(r),i.svg&&f.renderSvg(r,i.svg)};r.dom={elements:i,bounds:c,redraw:n(a),redrawNow:a,unbind:o,relative:s},r.drawable.prevSvgHash="",a(!1),m.bindBoard(r,l),o||(r.dom.unbind=m.bindDocument(r,l)),r.events.insert&&r.events.insert(i)}return c.configure(r,o||{}),s(),p.start(r,s)}})).Shogiground}();
