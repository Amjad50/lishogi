var Shogiground=function(){"use strict";const e=["sente","gote"],t=["a","b","c","d","e","f","g","h","i"],o=["1","2","3","4","5","6","7","8","9"],n=["9","8","7","6","5","4","3","2","1"],r=Array.prototype.concat(...t.map((e=>o.map((t=>e+t))))),s=e=>r[9*e[0]+e[1]],i=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49];const c=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},a=e=>"sente"===e?"gote":"sente",l=(e,t)=>{const o=e[0]-t[0],n=e[1]-t[1];return o*o+n*n},d=(e,t)=>e.role===t.role&&e.color===t.color,u=(e,t,o,n)=>[(t?e[0]:8-e[0])*o,(t?8-e[1]:e[1])*n],p=e=>{const t=e.width/9,o=e.height/9;return(e,n)=>u(e,n,t,o)},f=(e,t)=>u(e,t,50,50),g=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(0.5)`},h=(e,t)=>{e.style.transform=`translate(${t[0]}%,${t[1]}%) scale(0.5)`},m=(e,t)=>{e.style.visibility=t?"visible":"hidden"},b=e=>e.clientX||0===e.clientX?[e.clientX,e.clientY]:e.touches&&e.targetTouches[0]?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0,v=e=>2===e.buttons||2===e.button,w=(e,t)=>{const o=document.createElement(e);return t&&(o.className=t),o},y=["pawn","lance","knight","silver","gold","bishop","rook"];function k(e,t){return Math.abs(e-t)}const C=(e,t,o,n)=>k(e,o)===k(t,n),M=(e,t,o,n)=>e===o||t===n,P=(e,t,o,n)=>k(e,o)<2&&k(t,n)<2;const S=(e,t,o,n)=>P(e,t,o,n)||C(e,t,o,n),D=(e,t,o,n)=>P(e,t,o,n)||M(e,t,o,n),L=r.map(i);function A(e,t){const o=e.get(t);if(!o)return[];const n=i(t),r=o.role,c="pawn"===r?(a=o.color,(e,t,o,n)=>"sente"===a?e===o&&t+1===n:e===o&&t-1===n):"knight"===r?function(e){return(t,o,n,r)=>1===k(t,n)&&2===k(o,r)&&("sente"===e?r>o:r<o)}(o.color):"bishop"===r?C:"rook"===r?M:"king"===r?P:"silver"===r?function(e){return(t,o,n,r)=>k(t,n)<2&&k(o,r)<2&&o!=r&&("sente"===e?t!=n||r>o:t!=n||r<o)}(o.color):"lance"===r?function(e){return(t,o,n,r)=>"sente"===e?t==n&&r>o:t==n&&o>r}(o.color):"horse"===r?S:"dragon"===r?D:function(e){return(t,o,n,r)=>k(t,n)<2&&k(o,r)<2&&("sente"===e?r>=o||t==n:r<=o||t==n)}(o.color);var a;return L.filter((e=>(n[0]!==e[0]||n[1]!==e[1])&&c(n[0],n[1],e[0],e[1]))).map(s)}function x(e,...t){e&&setTimeout((()=>e(...t)),1)}function K(e){e.premovable.current&&(e.premovable.current=void 0,x(e.premovable.events.unset))}function N(e){const t=e.predroppable;t.current&&(t.current=void 0,x(t.events.unset))}function O(e,t,o){const n=e.pieces.get(t),r=e.pieces.get(o);if(t===o||!n)return!1;const s=r&&r.color!==n.color?r:void 0;return o===e.selected&&T(e),x(e.events.move,t,o,s),e.pieces.set(o,n),e.pieces.delete(t),e.lastMove=[t,o],e.check=void 0,x(e.events.change),s||!0}function E(e,t,o,n){if(e.pieces.has(o)){if(!n)return!1;e.pieces.delete(o)}return x(e.events.dropNewPiece,t,o),e.pieces.set(o,t),e.lastMove=[o],e.check=void 0,x(e.events.change),e.movable.dests=void 0,e.dropmode.dropDests=void 0,e.turnColor=a(e.turnColor),!0}function W(e,t,o){const n=O(e,t,o);return n&&(e.movable.dests=void 0,e.dropmode.dropDests=void 0,e.turnColor=a(e.turnColor),e.animation.current=void 0),n}function $(e,t,o){if(I(e,t,o)){const n=W(e,t,o);if(n){const r=e.hold.stop();T(e);const s={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return!0!==n&&(s.captured=n),x(e.movable.events.after,t,o,s),!0}}else if(function(e,t,o){return t!==o&&j(e,t)&&A(e.pieces,t).includes(o)}(e,t,o))return function(e,t,o,n){N(e),e.premovable.current=[t,o],x(e.premovable.events.set,t,o,n)}(e,t,o,{ctrlKey:e.stats.ctrlKey}),T(e),!0;return T(e),!1}function z(e,t,o,n){const r=e.pieces.get(t);r&&(function(e,t,o){const n=e.pieces.get(t);return!(!n||t!==o&&e.pieces.has(o)||"both"!==e.movable.color&&(e.movable.color!==n.color||e.turnColor!==n.color))}(e,t,o)||n)?(e.pieces.delete(t),E(e,r,o,n),x(e.movable.events.afterNewPiece,r.role,o,{predrop:!1})):r&&function(e,t,o){const n=e.pieces.get(t),r=e.pieces.get(o);return!!n&&(!r||r.color!==e.movable.color)&&e.predroppable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}(e,t,o)?function(e,t,o){K(e),e.predroppable.current={role:t,key:o},x(e.predroppable.events.set,t,o)}(e,r.role,o):(K(e),N(e)),e.pieces.delete(t),T(e)}function q(e,t,o){if(x(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled)return T(e),void e.hold.cancel();if((e.selectable.enabled||o)&&e.selected!==t&&$(e,e.selected,t))return void(e.stats.dragged=!1)}(B(e,t)||j(e,t))&&(F(e,t),e.hold.start())}function F(e,t){e.selected=t,j(e,t)?e.premovable.dests=A(e.pieces,t):(e.premovable.dests=void 0,e.predroppable.dropDests=void 0)}function T(e){e.selected=void 0,e.premovable.dests=void 0,e.predroppable.dropDests=void 0,e.hold.cancel()}function B(e,t){const o=e.pieces.get(t);return!!o&&("both"===e.movable.color||e.movable.color===o.color&&e.turnColor===o.color)}function I(e,t,o){var n,r;return t!==o&&B(e,t)&&(e.movable.free||!!(null===(r=null===(n=e.movable.dests)||void 0===n?void 0:n.get(t))||void 0===r?void 0:r.includes(o)))}function j(e,t){const o=e.pieces.get(t);return!!o&&e.premovable.enabled&&e.movable.color===o.color&&e.turnColor!==o.color}function H(e){const t=e.premovable.current;if(!t)return!1;const o=t[0],n=t[1];let r=!1;if(I(e,o,n)){const t=W(e,o,n);if(t){const s={premove:!0};!0!==t&&(s.captured=t),x(e.movable.events.after,o,n,s),r=!0}}return K(e),r}function G(e){K(e),N(e),T(e)}function R(e){e.movable.color=e.movable.dests=e.dropmode.dropDests=e.animation.current=void 0,G(e)}function X(e,t,o){let n=Math.floor(9*(e[0]-o.left)/o.width);t||(n=8-n);let r=8-Math.floor(9*(e[1]-o.top)/o.height);return t||(r=8-r),n>=0&&n<9&&r>=0&&r<9?s([n,r]):void 0}function Z(e){return"sente"===e.orientation}const Y="lnsgkgsnl/1r5b1/ppppppppp/9/9/9/PPPPPPPPP/1B5R1/LNSGKGSNL",U={p:"pawn",l:"lance",n:"knight",s:"silver",g:"gold",b:"bishop",r:"rook",k:"king","+p":"tokin",t:"tokin","+l":"promotedlance",u:"promotedlance","+n":"promotedknight",m:"promotedknight","+s":"promotedsilver",a:"promotedsilver","+b":"horse",h:"horse","+r":"dragon",d:"dragon"},J={pawn:"p",lance:"l",knight:"n",silver:"s",gold:"g",bishop:"b",rook:"r",king:"k",tokin:"+p",promotedlance:"+l",promotedknight:"+n",promotedsilver:"+s",horse:"+b",dragon:"+r"};function Q(e){"start"===e&&(e=Y);const t=new Map;let o=8,n=0;for(let r=0;r<e.length;r++)switch(e[r]){case" ":case"_":return t;case"/":if(--o,o<0)return t;n=0;break;default:const i=e[r].charCodeAt(0);if(i<58&&43!=i)n+=i-48;else{const i="+"===e[r]&&e.length>r+1?"+"+e[++r].toLowerCase():e[r].toLowerCase(),c=e[r]===i||"+"+e[r]===i?"gote":"sente";t.set(s([n,o]),{role:U[i],color:c}),++n}}return t}const V={p:"pawn",l:"lance",n:"knight",s:"silver",g:"gold",b:"bishop",r:"rook"};function _(e,t,o){const n="sente"===e.orientation!=("sente"==o)?"top":"bottom",r=w("div","pocket is2d pocket-"+n);t.appendChild(r);for(const e of y){const t=w("div","pocket-c1");r.appendChild(t);const n=w("div","pocket-c2");t.appendChild(n);const s=w("piece",e+" "+o);s.setAttribute("data-role",e),s.setAttribute("data-color",o),s.setAttribute("data-nb","0"),n.appendChild(s)}return r}function ee(e,t){var o,n;(null===(o=t.movable)||void 0===o?void 0:o.dests)&&(e.movable.dests=void 0),(null===(n=t.dropmode)||void 0===n?void 0:n.dropDests)&&(e.dropmode.dropDests=void 0),te(e,t),t.fen&&(e.pieces=Q(t.fen),e.drawable.shapes=[]),t.hasPockets&&(e.pockets=function(e){const t=[{pawn:0,lance:0,knight:0,silver:0,gold:0,bishop:0,rook:0},{pawn:0,lance:0,knight:0,silver:0,gold:0,bishop:0,rook:0}];if(!e)return t;try{let o=JSON.parse(e);for(const e of[0,1])for(const n of y)t[e][n]=o[e][n]||0}catch(o){let n=0;for(const o of e){const e=V[o.toLowerCase()];e?(t[o.toLowerCase()===o?1:0][e]+=n||1,n=0):n=10*n+Number(o)}}return t}(t.pockets)),t.hasOwnProperty("check")&&function(e,t){if(e.check=void 0,!0===t&&(t=e.turnColor),t)for(const[o,n]of e.pieces)"king"===n.role&&n.color===t&&(e.check=o)}(e,t.check||!1),t.hasOwnProperty("lastMove")&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&F(e,e.selected),(!e.animation.duration||e.animation.duration<100)&&(e.animation.enabled=!1)}function te(e,t){for(const o in t)oe(e[o])&&oe(t[o])?te(e[o],t[o]):e[o]=t[o]}function oe(e){return"object"==typeof e}function ne(e,t){return t.animation.enabled?function(e,t){const o=new Map(t.pieces),n=e(t),s=function(e,t){const o=new Map,n=[],s=new Map,i=[],c=[],a=new Map;let l,u,p;for(const[t,o]of e)a.set(t,se(t,o));for(const e of r)l=t.pieces.get(e),u=a.get(e),l?u?d(l,u.piece)||(i.push(u),c.push(se(e,l))):c.push(se(e,l)):u&&i.push(u);for(const e of c)u=ie(e,i.filter((t=>d(e.piece,t.piece)))),u&&(p=[u.pos[0]-e.pos[0],u.pos[1]-e.pos[1]],o.set(e.key,p.concat(p)),n.push(u.key));for(const e of i)n.includes(e.key)||s.set(e.key,e.piece);return{anims:o,fadings:s}}(o,t);if(s.anims.size||s.fadings.size){const e=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:s},e||ce(t,performance.now())}else t.dom.redraw();return n}(e,t):re(e,t)}function re(e,t){const o=e(t);return t.dom.redraw(),o}function se(e,t){return{key:e,pos:i(e),piece:t}}function ie(e,t){return t.sort(((t,o)=>l(e.pos,t.pos)-l(e.pos,o.pos)))[0]}function ce(e,t){const o=e.animation.current;if(void 0===o)return void(e.dom.destroyed||e.dom.redrawNow());const n=1-(t-o.start)*o.frequency;if(n<=0)e.animation.current=void 0,e.dom.redrawNow();else{const t=(r=n)<.5?4*r*r*r:(r-1)*(2*r-2)*(2*r-2)+1;for(const e of o.plan.anims.values())e[2]=e[0]*t,e[3]=e[1]*t;e.dom.redrawNow(!0),requestAnimationFrame(((t=performance.now())=>ce(e,t)))}var r}const ae=["green","red","blue","yellow"];function le(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?T(e):G(e);const o=b(t),n=X(o,Z(e),e.dom.bounds()),r=e.drawable.piece;n&&(e.drawable.current={orig:n,pos:o,piece:r,brush:ge(t)},de(e))}function de(e){requestAnimationFrame((()=>{const t=e.drawable.current;if(t){const o=X(t.pos,Z(e),e.dom.bounds());o!==t.mouseSq&&(t.mouseSq=o,t.dest=o!==t.orig?o:void 0,t.piece=t.dest?void 0:e.drawable.piece,e.dom.redrawNow()),de(e)}}))}function ue(e,t){e.drawable.current&&(e.drawable.current.pos=b(t))}function pe(e){const t=e.drawable.current;t&&(t.mouseSq&&function(e,t){const o=e=>e.orig===t.orig&&e.dest===t.dest,n=e=>e.orig===t.orig&&e.piece&&t.piece&&(e.piece.color!==t.piece.color||e.piece.role!==t.piece.role),r=e.shapes.find(o),s=e.shapes.find(n);r&&(e.shapes=e.shapes.filter((e=>!o(e))));r&&r.brush===t.brush&&!s||e.shapes.push(t);!t.piece||r&&r.brush===t.brush&&!s||e.shapes.push({orig:t.orig,brush:t.brush});he(e)}(e.drawable,t),fe(e))}function fe(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function ge(e){const t=(e.shiftKey||e.ctrlKey)&&v(e),o=e.altKey||e.metaKey||e.getModifierState("AltGraph");return ae[(t?1:0)+(o?2:0)]}function he(e){e.onChange&&e.onChange(e.shapes)}function me(e,t){if(void 0!==t.button&&0!==t.button)return;if(t.touches&&t.touches.length>1)return;const o=e.dom.bounds(),n=b(t),r=X(n,Z(e),o);if(!r)return;const s=e.pieces.get(r),c=e.selected;var a;c||!e.drawable.enabled||!e.drawable.eraseOnClick&&s&&s.color===e.turnColor||(a=e).drawable.shapes.length&&(a.drawable.shapes=[],a.dom.redraw(),he(a.drawable)),!1===t.cancelable||t.touches&&e.movable.color&&!s&&!c&&!function(e,t){const o=Z(e),n=e.dom.bounds(),r=Math.pow(n.width/9,2);for(const s in e.pieces){const e=Me(s,o,n);if(l(e,t)<=r)return!0}return!1}(e,n)||t.preventDefault();const d=!!e.premovable.current,u=!!e.predroppable.current||!!e.predroppable.dropDests;e.stats.ctrlKey=t.ctrlKey,e.selected&&I(e,e.selected,r)?ne((e=>q(e,r)),e):q(e,r);const f=e.selected===r,h=Pe(e,r);if(s&&h&&f&&function(e,t){const o=e.pieces.get(t);return!!o&&e.draggable.enabled&&("both"===e.movable.color||e.movable.color===o.color&&(e.turnColor===o.color||e.premovable.enabled))}(e,r)){e.draggable.current={orig:r,piece:s,origPos:n,pos:n,started:e.draggable.autoDistance&&e.stats.dragged,element:h,previouslySelected:c,originTarget:t.target},h.cgDragging=!0,h.classList.add("dragging"),h.classList.remove("fix-blur");const a=e.dom.elements.ghost;a&&(a.className=`ghost ${s.color} ${s.role}`,g(a,p(o)(i(r),Z(e))),m(a,!0)),ve(e)}else d&&K(e),u&&N(e);e.dom.redraw()}function be(e,t,o,n){const s="a0";e.pieces.set(s,t),T(e),e.dom.redraw();const i=b(o);e.draggable.current={orig:s,piece:t,origPos:i,pos:i,started:!0,element:()=>Pe(e,s),originTarget:o.target,newPiece:!0,force:!!n},t&&function(e){var t,o;const n=e.dropmode.active?e.dropmode.piece:null===(t=e.draggable.current)||void 0===t?void 0:t.piece;return!!n&&(e.dropmode.active||"a0"===(null===(o=e.draggable.current)||void 0===o?void 0:o.orig))&&e.predroppable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}(e)&&(e.predroppable.dropDests=function(e,t){const o=t.color,n=t.role;return r.filter((t=>{const r=e.get(t);return!(r&&r.color===o||("pawn"===n||"lance"===n?function(e,t){return"sente"===t?"9"===e[1]:"1"===e[1]}(t,o):"knight"===n&&function(e,t){return"sente"===t?"8"===e[1]||"9"===e[1]:"1"===e[1]||"2"===e[1]}(t,o)))}))}(e.pieces,t)),ve(e)}function ve(e){requestAnimationFrame((()=>{var t;const o=e.draggable.current;if(!o)return;(null===(t=e.animation.current)||void 0===t?void 0:t.plan.anims.has(o.orig))&&(e.animation.current=void 0);const n=e.pieces.get(o.orig);if(n&&d(n,o.piece)){if(!o.started&&l(o.pos,o.origPos)>=Math.pow(e.draggable.distance,2)&&(o.started=!0),o.started){if("function"==typeof o.element){const e=o.element();if(!e)return;e.cgDragging=!0,e.classList.add("dragging"),e.classList.remove("fix-blur"),o.element=e}const t=e.dom.bounds();g(o.element,[o.pos[0]-t.left-t.width/18,o.pos[1]-t.top-t.height/18])}}else ke(e);ve(e)}))}function we(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=b(t))}function ye(e,t){const o=e.draggable.current;if(!o)return;if("touchend"===t.type&&!1!==t.cancelable&&t.preventDefault(),"touchend"===t.type&&o.originTarget!==t.target&&!o.newPiece)return void(e.draggable.current=void 0);K(e),N(e);const n=X(b(t)||o.pos,Z(e),e.dom.bounds());n&&o.started&&o.orig!==n?o.newPiece?z(e,o.orig,n,o.force):(e.stats.ctrlKey=t.ctrlKey,$(e,o.orig,n)&&(e.stats.dragged=!0)):o.newPiece?e.pieces.delete(o.orig):e.draggable.deleteOnDropOff&&!n&&(e.pieces.delete(o.orig),x(e.events.change)),(o.orig!==o.previouslySelected||o.orig!==n&&n)&&e.selectable.enabled||T(e),Ce(e),e.draggable.current=void 0,e.dom.redraw()}function ke(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,T(e),Ce(e),e.dom.redraw())}function Ce(e){const t=e.dom.elements;t.ghost&&m(t.ghost,!1)}function Me(e,t,o){const n=i(e);return t||(n[0]=8-n[0],n[1]=8-n[1]),[o.left+o.width*n[0]/9+o.width/18,o.top+o.height*(8-n[1])/9+o.height/18]}function Pe(e,t){let o=e.dom.elements.board.firstChild;for(;o;){if(o.cgKey===t&&"PIECE"===o.tagName)return o;o=o.nextSibling}}function Se(e,o){function r(){!function(e){e.orientation=a(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}(e),o()}return{set(t){t.orientation&&t.orientation!==e.orientation&&r(),(t.fen?ne:re)((e=>ee(e,t)),e)},state:e,getFen:()=>{return o=e.pieces,n.map((e=>t.map((t=>{const n=o.get(t+e);if(n){const e=J[n.role];return"sente"===n.color?e.toUpperCase():e}return"1"})).join(""))).join("/").replace(/1{2,}/g,(e=>e.length.toString()));var o},toggleOrientation:r,setPieces(t){ne((e=>function(e,t){for(const[o,n]of t)n?e.pieces.set(o,n):e.pieces.delete(o)}(e,t)),e)},selectSquare(t,o){t?ne((e=>q(e,t,o)),e):e.selected&&(T(e),e.dom.redraw())},move(t,o){ne((e=>O(e,t,o)),e)},newPiece(t,o){ne((e=>E(e,t,o)),e)},playPremove(){if(e.premovable.current){if(ne(H,e))return!0;e.dom.redraw()}return!1},playPredrop(t){if(e.predroppable.current){const o=function(e,t){const o=e.predroppable.current;let n=!1;if(!o)return!1;t(o)&&E(e,{role:o.role,color:e.movable.color},o.key)&&(x(e.movable.events.afterNewPiece,o.role,o.key,{predrop:!0}),n=!0);return N(e),n}(e,t);return e.dom.redraw(),o}return!1},cancelPremove(){re(K,e)},cancelPredrop(){re(N,e)},cancelMove(){re((e=>{G(e),ke(e)}),e)},stop(){re((e=>{R(e),ke(e)}),e)},setAutoShapes(t){re((e=>e.drawable.autoShapes=t),e)},setShapes(t){re((e=>e.drawable.shapes=t),e)},getKeyAtDomPos:t=>X(t,Z(e),e.dom.bounds()),redrawAll:o,dragNewPiece(t,o,n){be(e,t,o,n)},destroy(){R(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function De(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function Le(e,t){const o=e.drawable,n=o.current,r=n&&n.mouseSq?n:void 0,s=new Map,i=e.dom.bounds();for(const e of o.shapes.concat(o.autoShapes).concat(r?[r]:[]))e.dest&&s.set(e.dest,(s.get(e.dest)||0)+1);const c=o.shapes.concat(o.autoShapes).map((e=>({shape:e,current:!1,hash:Ae(e,s,!1,i)})));r&&c.push({shape:r,current:!0,hash:Ae(r,s,!0,i)});const a=c.map((e=>e.hash)).join(";");if(a===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=a;const l=t.firstChild;!function(e,t,o){const n=new Map;let r;for(const o of t)o.shape.dest&&(r=e.brushes[o.shape.brush],o.shape.modifiers&&(r=We(r,o.shape.modifiers)),n.set(r.key,r));const s=new Set;let i=o.firstChild;for(;i;)s.add(i.getAttribute("cgKey")),i=i.nextSibling;for(const[e,t]of n.entries())s.has(e)||o.appendChild(Ne(t))}(o,c,l),function(e,t,o,n,r,s){const i=e.dom.bounds(),c=new Map,a=[];for(const e of t)c.set(e.hash,!1);let l,d=s.nextSibling;for(;d;)l=d.getAttribute("cgHash"),c.has(l)?c.set(l,!0):a.push(d),d=d.nextSibling;for(const e of a)r.removeChild(e);for(const s of t)c.get(s.hash)||r.appendChild(Ke(e,s,o,n,i))}(e,c,o.brushes,s,t,l)}function Ae({orig:e,dest:t,brush:o,piece:n,modifiers:r},s,i,c){return[c.width,c.height,i,e,t,o,t&&(s.get(t)||0)>1,n&&xe(n),r&&(a=r,""+(a.lineWidth||""))].filter((e=>e)).join(",");var a}function xe(e){return[e.color,e.role,e.scale].filter((e=>e)).join(",")}function Ke(e,{shape:t,current:o,hash:n},r,s,c){let a;if(t.piece&&!t.dest)a=function(e,t,o){const n=qe(e,o),r=o.width/9*(t.scale||.8);let s=Oe(De("foreignObject"),{className:`${t.role} ${t.color}`,x:n[0]-r/2,y:n[1]-r/2,width:r,height:r}),i=w("piece",`${t.color} ${t.role}`);return i.style.width="200%",i.style.height="200%",i.style.margin="-50%",s.append(i),s}(Ee(i(t.orig),e.orientation),t.piece,c);else{const n=Ee(i(t.orig),e.orientation);if(t.dest){let l=r[t.brush];t.modifiers&&(l=We(l,t.modifiers)),a=function(e,t,o,n,r,s){const i=function(e,t){return(t?20:10)/512*e.width}(s,r&&!n),c=qe(t,s),a=qe(o,s),l=a[0]-c[0],d=a[1]-c[1],u=Math.atan2(d,l),p=Math.cos(u)*i,f=Math.sin(u)*i;return Oe(De("line"),{stroke:e.color,"stroke-width":$e(e,n,s),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:ze(e,n),x1:c[0],y1:c[1],x2:a[0]-p,y2:a[1]-f})}(l,n,Ee(i(t.dest),e.orientation),o,(s.get(t.dest)||0)>1,c)}else a=function(e,t,o,n){const r=qe(t,n),s=function(e){const t=e.width/512;return[3*t,4*t]}(n),i=(n.width+n.height)/36;return Oe(De("circle"),{stroke:e.color,"stroke-width":s[o?0:1],fill:"none",opacity:ze(e,o),cx:r[0],cy:r[1],r:i-s[1]/2})}(r[t.brush],n,o,c)}return a.setAttribute("cgHash",n),a}function Ne(e){const t=Oe(De("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return t.appendChild(Oe(De("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function Oe(e,t){for(const o in t)e.setAttribute(o,t[o]);return e}function Ee(e,t){return"sente"===t?e:[8-e[0],8-e[1]]}function We(e,t){return{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter((e=>e)).join("")}}function $e(e,t,o){return(e.lineWidth||10)*(t?.85:1)/512*o.width}function ze(e,t){return(e.opacity||1)*(t?.9:1)}function qe(e,t){return[(e[0]+.5)*t.width/9,(8.5-e[1])*t.height/9]}function Fe(t,o,n){t.innerHTML="",t.classList.add("cg-wrap");for(const n of e)t.classList.toggle("orientation-"+n,o.orientation===n);t.classList.toggle("manipulable",!o.viewOnly);const r=w("cg-container");t.appendChild(r);const s=w("cg-board");let i;var c;let a,l;if(r.appendChild(s),c=t,Array.from(c.classList).includes("mini-board")?o.pockets?(i=[w("cg-pocket"),w("cg-pocket")],r.insertBefore(i["sente"===o.orientation?1:0],s),r.insertBefore(i["sente"===o.orientation?0:1],s.nextSibling)):t.classList.add("no-pockets"):delete o.pockets,o.drawable.visible&&!n&&(a=De("svg"),a.appendChild(De("defs")),r.appendChild(a)),o.coordinates){const e="gote"===o.orientation?" gote":"";0===o.notation||1===o.notation?r.appendChild(Te(["9","8","7","6","5","4","3","2","1"],"ranks"+e)):3===o.notation?r.appendChild(Te(["i","h","g","f","e","d","c","b","a"],"ranks"+e)):r.appendChild(Te(["九","八","七","六","五","四","三","二","一"],"ranks"+e)),r.appendChild(Te(["9","8","7","6","5","4","3","2","1"],"files"+e))}return o.draggable.showGhost&&!n&&(l=w("piece","ghost"),m(l,!1),r.appendChild(l)),{board:s,container:r,boardSpan:t,ghost:l,svg:a,pockets:i}}function Te(e,t){const o=w("coords",t);let n;for(const t of e)n=w("coord"),n.textContent=t,o.appendChild(n);return o}function Be(e,t){const o=e.dom.elements.board;if(!e.dom.relative&&e.resizable&&"ResizeObserver"in window&&new ResizeObserver(t).observe(o),e.viewOnly)return;const n=function(e){return t=>{e.draggable.current?ke(e):e.drawable.current?fe(e):t.shiftKey||v(t)?e.drawable.enabled&&le(e,t):e.viewOnly||(e.dropmode.active&&!function(e,t){const o=b(t),n=o&&X(o,Z(e),e.dom.bounds());return!(!n||!e.pieces.has(n))}(e,t)?function(e,t){if(!e.dropmode.active)return;K(e),N(e);const o=e.dropmode.piece;if(o){e.pieces.set("a0",o);const n=b(t),r=n&&X(n,Z(e),e.dom.bounds());r&&z(e,"a0",r)}e.dom.redraw()}(e,t):(!function(e){e.dropmode.active=!1,e.dropmode.piece=void 0}(e),me(e,t)))}}(e);o.addEventListener("touchstart",n,{passive:!1}),o.addEventListener("mousedown",n,{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&o.addEventListener("contextmenu",(e=>e.preventDefault()))}function Ie(e,t,o,n){return e.addEventListener(t,o,n),()=>e.removeEventListener(t,o,n)}function je(e,t,o){return n=>{e.drawable.current?e.drawable.enabled&&o(e,n):e.viewOnly||t(e,n)}}function He(e){const t=Z(e),o=e.dom.relative?f:p(e.dom.bounds()),n=e.dom.relative?h:g,r=e.dom.elements.board,s=e.dom.elements.pockets,c=e.pieces,a=e.animation.current,l=a?a.plan.anims:new Map,d=a?a.plan.fadings:new Map,u=e.draggable.current,m=function(e){var t,o,n,r;const s=new Map;if(e.lastMove&&e.highlight.lastMove)for(const t of e.lastMove)t.includes("*")||Ue(s,t,"last-move");e.check&&e.highlight.check&&Ue(s,e.check,"check");if(e.selected){if(Ue(s,e.selected,"selected"),e.movable.showDests){const o=null===(t=e.movable.dests)||void 0===t?void 0:t.get(e.selected);if(o)for(const t of o)Ue(s,t,"move-dest"+(e.pieces.has(t)?" oc":""));const n=e.premovable.dests;if(n)for(const t of n)Ue(s,t,"premove-dest"+(e.pieces.has(t)?" oc":""))}}else if(e.dropmode.active||"a0"===(null===(o=e.draggable.current)||void 0===o?void 0:o.orig)){const t=e.dropmode.active?e.dropmode.piece:null===(n=e.draggable.current)||void 0===n?void 0:n.piece;if(t&&e.dropmode.showDropDests){const o=null===(r=e.dropmode.dropDests)||void 0===r?void 0:r.get(t.role);if(o)for(const e of o)Ue(s,e,"move-dest");const n=e.predroppable.dropDests;if(n&&!o)for(const t of n)Ue(s,t,"premove-dest"+(e.pieces.has(t)?" oc":""))}}const i=e.premovable.current;if(i)for(const e of i)Ue(s,e,"current-premove");else e.predroppable.current&&Ue(s,e.predroppable.current.key,"current-premove");return s}(e),b=new Set,v=new Set,y=new Map,k=new Map;let C,M,P,S,D,L,A,x,K,N;for(M=r.firstChild;M;){if(C=M.cgKey,Ge(M))if(P=c.get(C),D=l.get(C),L=d.get(C),S=M.cgPiece,M.classList.remove("fix-blur"),"a0"===C&&M.classList.add("fix-blur"),!M.cgDragging||u&&u.orig===C||(M.classList.remove("dragging"),n(M,o(i(C),t)),M.cgDragging=!1),!L&&M.cgFading&&(M.cgFading=!1,M.classList.remove("fading")),P){if(D&&M.cgAnimating&&S===Ye(P)){const e=i(C);e[0]+=D[2],e[1]+=D[3],M.classList.add("anim"),n(M,o(e,t))}else M.cgAnimating&&(M.cgAnimating=!1,M.classList.remove("anim"),n(M,o(i(C),t)),e.addPieceZIndex&&(M.style.zIndex=Ze(i(C),t)));S!==Ye(P)||L&&M.cgFading?L&&S===Ye(L)?(M.classList.add("fading"),M.cgFading=!0):Je(y,S,M):b.add(C)}else Je(y,S,M);else if(Re(M)){const e=M.className;m.get(C)===e?v.add(C):Je(k,e,M)}M=M.nextSibling}for(const[e,s]of m)if(!v.has(e)){K=k.get(s),N=K&&K.pop();const c=o(i(e),t);if(N)N.cgKey=e,n(N,c);else{const t=w("square",s);t.cgKey=e,n(t,c),r.insertBefore(t,r.firstChild)}}for(const[s,a]of c)if(D=l.get(s),!b.has(s))if(A=y.get(Ye(a)),x=A&&A.pop(),x){x.cgKey=s,x.cgFading&&(x.classList.remove("fading"),x.cgFading=!1);const r=i(s);e.addPieceZIndex&&(x.style.zIndex=Ze(r,t)),D&&(x.cgAnimating=!0,x.classList.add("anim"),r[0]+=D[2],r[1]+=D[3]),n(x,o(r,t))}else{const c=Ye(a),l=w("piece",c),d=i(s);l.cgPiece=c,l.cgKey=s,D&&(l.cgAnimating=!0,d[0]+=D[2],d[1]+=D[3]),n(l,o(d,t)),e.addPieceZIndex&&(l.style.zIndex=Ze(d,t)),r.appendChild(l)}if(e.pockets&&s)for(const t of[0,1]){const o=(s[t].firstElementChild||_(e,s[t],0===t?"sente":"gote")).getElementsByTagName("piece");for(let n=0;n<o.length;n++){const r=o[n].getAttribute("data-role");o[n].setAttribute("data-nb",e.pockets[t][r||""])}}for(const t of y.values())Xe(e,t);for(const t of k.values())Xe(e,t)}function Ge(e){return"PIECE"===e.tagName}function Re(e){return"SQUARE"===e.tagName}function Xe(e,t){for(const o of t)e.dom.elements.board.removeChild(o)}function Ze(e,t){let o=2+9*e[1]+(8-e[0]);return t&&(o=84-o),o+""}function Ye(e){return`${e.color} ${e.role}`}function Ue(e,t,o){const n=e.get(t);n?e.set(t,`${n} ${o}`):e.set(t,o)}function Je(e,t,o){const n=e.get(t);n?n.push(o):e.set(t,[o])}function Qe(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame((()=>{e(),t=!1})))}}return function(e,t){const o={pieces:Q(Y),orientation:"sente",turnColor:"sente",coordinates:!0,viewOnly:!1,disableContextMenu:!1,resizable:!0,addPieceZIndex:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{}},premovable:{enabled:!0,showDests:!0,events:{}},predroppable:{enabled:!0,showDropDests:!0,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1,showDropDests:!0},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},prevSvgHash:""},hold:c()};function n(){const t=o.dom&&o.dom.unbind,n=o.viewOnly&&!o.drawable.visible,r=Fe(e,o,n),s=function(e){let t;const o=()=>(void 0===t&&(t=e()),t);return o.clear=()=>{t=void 0},o}((()=>r.board.getBoundingClientRect())),c=e=>{He(o),!e&&r.svg&&Le(o,r.svg)},a=()=>{s.clear(),function(e){if(e.dom.relative)return;const t=Z(e),o=p(e.dom.bounds());let n=e.dom.elements.board.firstChild;for(;n;)(Ge(n)&&!n.cgAnimating||Re(n))&&g(n,o(i(n.cgKey),t)),n=n.nextSibling}(o),r.svg&&Le(o,r.svg)};o.dom={elements:r,bounds:s,redraw:Qe(c),redrawNow:c,unbind:t,relative:n},o.drawable.prevSvgHash="",c(!1),Be(o,a),t||(o.dom.unbind=function(e,t){const o=[];if(e.dom.relative||!e.resizable||"ResizeObserver"in window||o.push(Ie(document.body,"shogiground.resize",t)),!e.viewOnly){const t=je(e,we,ue),n=je(e,ye,pe);for(const e of["touchmove","mousemove"])o.push(Ie(document,e,t));for(const e of["touchend","mouseup"])o.push(Ie(document,e,n));const r=()=>e.dom.bounds.clear();o.push(Ie(document,"scroll",r,{capture:!0,passive:!0})),o.push(Ie(window,"resize",r,{passive:!0}))}return()=>o.forEach((e=>e()))}(o,a)),o.events.insert&&o.events.insert(r)}return ee(o,t||{}),n(),Se(o,n)}}();
